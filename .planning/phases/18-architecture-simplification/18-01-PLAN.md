---
phase: 18-architecture-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/project-context.ts
  - src/commands/setup-aws-envs.ts
autonomous: true

must_haves:
  truths:
    - "setup-aws-envs creates access keys for deployment users in each child account"
    - "Deployment credentials (accessKeyId + secretAccessKey) are persisted to config file after each successful key creation"
    - "Re-running setup-aws-envs skips access key creation for environments that already have credentials in config"
    - "Config file contains deploymentCredentials field with per-environment credential objects"
  artifacts:
    - path: "src/utils/project-context.ts"
      provides: "DeploymentCredentials interface and deploymentCredentials field on ProjectConfigMinimal"
      contains: "deploymentCredentials"
    - path: "src/commands/setup-aws-envs.ts"
      provides: "Access key creation loop after deployment user creation"
      contains: "createAccessKey"
  key_links:
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/aws/iam.ts"
      via: "createAccessKey import"
      pattern: "import.*createAccessKey.*from.*iam"
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/utils/project-context.ts"
      via: "DeploymentCredentials type usage"
      pattern: "deploymentCredentials"
---

<objective>
Add deployment access key creation to setup-aws-envs and extend config schema to store credentials.

Purpose: Move access key creation from initialize-github into setup-aws-envs so all AWS/IAM operations are consolidated in one command. Credentials are persisted to config for downstream consumption.
Output: setup-aws-envs creates access keys immediately after deployment users and stores them in the project config file.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-architecture-simplification/18-RESEARCH.md
@src/utils/project-context.ts
@src/commands/setup-aws-envs.ts
@src/aws/iam.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config schema with DeploymentCredentials</name>
  <files>src/utils/project-context.ts</files>
  <action>
Add a `DeploymentCredentials` interface and `deploymentCredentials` optional field to `ProjectConfigMinimal` in `src/utils/project-context.ts`.

1. Add the following interface BEFORE the `ProjectConfigMinimal` interface:

```typescript
/**
 * Deployment credentials for a single environment
 * Created by setup-aws-envs, consumed by initialize-github
 */
export interface DeploymentCredentials {
  userName: string;
  accessKeyId: string;
  secretAccessKey: string;
}
```

2. Add the `deploymentCredentials` field to `ProjectConfigMinimal` (after `deploymentUsers`):

```typescript
deploymentCredentials?: Record<string, DeploymentCredentials>;
```

Do NOT modify any other fields or functions in this file. The interface addition is purely additive.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors.</verify>
  <done>DeploymentCredentials interface exported from project-context.ts. ProjectConfigMinimal has optional deploymentCredentials field.</done>
</task>

<task type="auto">
  <name>Task 2: Add access key creation and credential persistence to setup-aws-envs</name>
  <files>src/commands/setup-aws-envs.ts</files>
  <action>
Modify `src/commands/setup-aws-envs.ts` to create access keys after deployment users and persist credentials to config.

**Step 1: Add createAccessKey import**

Add `createAccessKey` to the existing import from `../aws/iam.js`:

```typescript
import {
  createIAMClient,
  createCrossAccountIAMClient,
  createOrAdoptDeploymentUser,
  createCDKDeploymentPolicy,
  attachPolicyToUser,
  createAccessKey,         // NEW
} from '../aws/iam.js';
```

Also add the DeploymentCredentials import from project-context:

```typescript
import { requireProjectContext, type DeploymentCredentials } from '../utils/project-context.js';
```

**Step 2: Extend updateConfig to accept deploymentCredentials**

Update the `updateConfig` function signature and body to accept an optional `deploymentCredentials` parameter:

```typescript
function updateConfig(
  configPath: string,
  accounts: Record<string, string>,
  deploymentUsers?: Record<string, string>,
  deploymentCredentials?: Record<string, DeploymentCredentials>
): void {
  const content = readFileSync(configPath, 'utf-8');
  const config = JSON.parse(content);

  config.accounts = { ...config.accounts, ...accounts };
  if (deploymentUsers) {
    config.deploymentUsers = { ...config.deploymentUsers, ...deploymentUsers };
  }
  if (deploymentCredentials) {
    config.deploymentCredentials = { ...config.deploymentCredentials, ...deploymentCredentials };
  }

  writeFileSync(configPath, JSON.stringify(config, null, 2) + '\n', 'utf-8');
}
```

**Step 3: Add existing credentials detection**

After the `const existingUsers` line (around line 254), add:

```typescript
const existingCredentials = config.deploymentCredentials ?? {};
```

**Step 4: Add access key creation loop after deployment user loop**

After the deployment user creation loop ends (after the `spinner.succeed` for deployment users), add a new section that creates access keys:

```typescript
// Create access keys for deployment users
const deploymentCredentials: Record<string, DeploymentCredentials> = {};

for (const env of ENVIRONMENTS) {
  // Skip if credentials already exist in config
  if (existingCredentials[env]) {
    spinner.succeed(`Using existing credentials for ${env}: ${existingCredentials[env].accessKeyId}`);
    deploymentCredentials[env] = existingCredentials[env];
    continue;
  }

  const userName = deploymentUsers[env];

  spinner.start(`Creating access key for ${env} deployment user...`);

  // Use the same cross-account IAM client pattern as deployment user creation
  const accountId = accounts[env];
  let iamClient: IAMClient;
  if (adminCredentials) {
    const roleArn = `arn:aws:iam::${accountId}:role/OrganizationAccountAccessRole`;
    iamClient = new IAMClient({
      region: config.awsRegion,
      credentials: fromTemporaryCredentials({
        masterCredentials: {
          accessKeyId: adminCredentials.accessKeyId,
          secretAccessKey: adminCredentials.secretAccessKey,
        },
        params: {
          RoleArn: roleArn,
          RoleSessionName: `create-aws-project-${Date.now()}`,
          DurationSeconds: 900,
        },
      }),
    });
  } else {
    iamClient = createCrossAccountIAMClient(config.awsRegion, accountId);
  }

  const credentials = await createAccessKey(iamClient, userName);

  deploymentCredentials[env] = {
    userName,
    accessKeyId: credentials.accessKeyId,
    secretAccessKey: credentials.secretAccessKey,
  };

  // Save after EACH successful key creation (partial failure resilience)
  updateConfig(configPath, accounts, deploymentUsers, deploymentCredentials);

  spinner.succeed(`Created access key for ${userName}`);
}
```

**Step 5: Update the success summary**

Update the summary table to include credential status. Change the final summary section from:

```
console.log(`  ${'Environment'.padEnd(14)}${'Account ID'.padEnd(16)}Deployment User`);
for (const env of ENVIRONMENTS) {
  console.log(`  ${env.padEnd(14)}${accounts[env].padEnd(16)}${deploymentUsers[env]}`);
}
```

to:

```
console.log(`  ${'Environment'.padEnd(14)}${'Account ID'.padEnd(16)}${'Deployment User'.padEnd(30)}Access Key`);
for (const env of ENVIRONMENTS) {
  const keyId = deploymentCredentials[env]?.accessKeyId ?? 'N/A';
  console.log(`  ${env.padEnd(14)}${accounts[env].padEnd(16)}${deploymentUsers[env].padEnd(30)}${keyId}`);
}
```

Also update the "Next steps" message. Change from:

```
console.log('Deployment users created. Next: initialize-github to create access keys and push to GitHub.');
```

to:

```
console.log('AWS setup complete with deployment credentials.');
console.log('');
console.log('Next: Push credentials to GitHub:');
```

The `npx create-aws-project initialize-github dev` suggestion line can stay as-is.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm no type errors.
2. Run `npm test` to confirm existing tests still pass.
  </verify>
  <done>setup-aws-envs creates access keys after deployment users, stores DeploymentCredentials in config per environment, skips key creation when credentials already exist, updates config after each key creation for partial failure resilience.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm test` passes (existing tests unaffected)
3. `DeploymentCredentials` interface is exported from `src/utils/project-context.ts`
4. `ProjectConfigMinimal` has `deploymentCredentials?: Record<string, DeploymentCredentials>` field
5. `setup-aws-envs.ts` imports `createAccessKey` from `../aws/iam.js`
6. `setup-aws-envs.ts` has access key creation loop after deployment user creation loop
7. `updateConfig` function accepts optional `deploymentCredentials` parameter
</verification>

<success_criteria>
- DeploymentCredentials type is defined and exported
- setup-aws-envs creates access keys in cross-account IAM clients for each environment
- Credentials are persisted to config file after each successful creation
- Re-runs skip environments that already have credentials in config
- TypeScript compiles without errors
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/18-architecture-simplification/18-01-SUMMARY.md`
</output>
