---
phase: 18-architecture-simplification
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/commands/initialize-github.ts
autonomous: true

must_haves:
  truths:
    - "initialize-github reads deployment credentials from config instead of making AWS API calls"
    - "initialize-github has zero imports from ../aws/ modules"
    - "initialize-github still prompts for GitHub PAT and handles environment selection"
    - "initialize-github still encrypts and pushes secrets to GitHub environments"
    - "initialize-github shows helpful error when credentials are missing (directs to setup-aws-envs)"
  artifacts:
    - path: "src/commands/initialize-github.ts"
      provides: "Config-based GitHub credential push (no AWS operations)"
      contains: "config.deploymentCredentials"
  key_links:
    - from: "src/commands/initialize-github.ts"
      to: "src/utils/project-context.ts"
      via: "reads deploymentCredentials from config"
      pattern: "config\\.deploymentCredentials"
    - from: "src/commands/initialize-github.ts"
      to: "src/github/secrets.ts"
      via: "pushes credentials to GitHub"
      pattern: "setEnvironmentCredentials"
---

<objective>
Simplify initialize-github to read credentials from config and push to GitHub without AWS operations.

Purpose: Remove all AWS/IAM operations from initialize-github so it becomes a pure GitHub configuration command. Credentials are read from config (created by setup-aws-envs in Plan 01).
Output: initialize-github reads pre-created deployment credentials from config and pushes them to GitHub secrets.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-architecture-simplification/18-RESEARCH.md
@.planning/phases/18-architecture-simplification/18-01-SUMMARY.md
@src/commands/initialize-github.ts
@src/github/secrets.ts
@src/utils/project-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove AWS imports and operations from initialize-github</name>
  <files>src/commands/initialize-github.ts</files>
  <action>
Rewrite `src/commands/initialize-github.ts` to remove all AWS/IAM operations and read credentials from config instead.

**Step 1: Remove AWS imports**

Remove these import lines entirely:
```typescript
import {
  createCrossAccountIAMClient,
  createDeploymentUserWithCredentials,
  createAccessKey,
} from '../aws/iam.js';
```

The remaining imports stay as-is:
- `ora` (spinner)
- `prompts` (PAT prompt, env selection)
- `pc` (colored output)
- `execSync` (git remote detection)
- `requireProjectContext` (config reading)
- `createGitHubClient, setEnvironmentCredentials, parseGitHubUrl, type GitHubRepoInfo` (GitHub operations)

**Step 2: Rewrite the main try block in runInitializeGitHub**

Replace the entire try block (lines ~339-421) with a simplified flow that reads credentials from config. The new try block should:

```typescript
try {
    // Step 1: Validate deployment credentials exist in config
    const credentials = config.deploymentCredentials?.[env];
    if (!credentials) {
      spinner.fail(`No deployment credentials found for ${env}`);
      console.error('');

      // Check if user exists but credentials don't (migration case)
      if (config.deploymentUsers?.[env]) {
        console.error(pc.yellow('Note:') + ' Deployment user exists but credentials were not found.');
        console.error('Your project may have been set up with an older version.');
        console.error('');
      }

      console.error('Run setup-aws-envs first to create deployment credentials:');
      console.error(`  ${pc.cyan('npx create-aws-project setup-aws-envs')}`);
      process.exit(1);
    }

    // Step 2: Configure GitHub environment
    const githubEnvName = GITHUB_ENV_NAMES[env];
    spinner.text = `Configuring GitHub Environment "${githubEnvName}"...`;
    const githubClient = createGitHubClient(pat);
    await setEnvironmentCredentials(
      githubClient,
      repoInfo.owner,
      repoInfo.repo,
      githubEnvName,
      credentials.accessKeyId,
      credentials.secretAccessKey
    );

    spinner.succeed(`Configured ${githubEnvName} environment`);

    // Success summary
    console.log('');
    console.log(pc.green(`${env} environment setup complete!`));
    console.log('');
    console.log('Credentials pushed to GitHub:');
    console.log(`  Deployment User: ${pc.cyan(credentials.userName)}`);
    console.log(`  Access Key ID: ${pc.cyan(credentials.accessKeyId)}`);
    console.log(`  GitHub Environment: ${pc.cyan(githubEnvName)}`);
    console.log('');
    console.log('View secrets at:');
    console.log(`  ${pc.cyan(`https://github.com/${repoInfo.owner}/${repoInfo.repo}/settings/environments`)}`);
    console.log('');

    // Show next steps (other environments if any remain)
    const remainingEnvs = VALID_ENVIRONMENTS.filter(
      (e) => e !== env && config.deploymentCredentials?.[e]
    );

    if (remainingEnvs.length > 0) {
      console.log(pc.bold('Next steps:'));
      console.log('');
      console.log('Configure remaining environments:');
      for (const remainingEnv of remainingEnvs) {
        console.log(`  ${pc.cyan(`npx create-aws-project initialize-github ${remainingEnv}`)}`);
      }
      console.log('');
    } else {
      console.log(pc.bold('All environments configured!'));
      console.log('');
      console.log('Deploy your application by pushing to the main branch:');
      console.log(`  ${pc.cyan('git push origin main')}`);
      console.log('');
    }
  } catch (error) {
    spinner.fail(`Failed to configure ${env} environment`);
    handleError(error, env);
  }
```

Note the key differences from the old code:
- No `createCrossAccountIAMClient` call
- No `createAccessKey` call
- No `createDeploymentUserWithCredentials` call
- Credentials read from `config.deploymentCredentials?.[env]`
- Remaining environments based on `config.deploymentCredentials` (not `config.accounts`)
- No "Note: Deployment user was created by setup-aws-envs" message (now always the case)
- No `awsRegion` or `accountId` needed from config (not used for AWS operations anymore)

**Step 3: Clean up the awsRegion destructure**

In the runInitializeGitHub function, the line:
```typescript
const { projectName, awsRegion } = config;
```

Should become:
```typescript
const { projectName } = config;
```

Since `awsRegion` is no longer used (was for IAM client creation). Also remove `projectName` if it's not used in the simplified flow (check: it was used for `createDeploymentUserWithCredentials` which is now removed). Actually `projectName` is not used in the new flow either, so the line can be removed entirely. But the `config` variable is still used, so keep the destructure of `config` from `context`.

**Step 4: Simplify accountId validation**

The section that validates `accountId` (lines ~311-319):
```typescript
const accountId = config.accounts?.[env];
if (!accountId) { ... }
```

This check is no longer needed since we don't use accountId for AWS operations. However, it's still useful as a sanity check that the environment was set up. Replace it with a check that the environment exists at all:

Remove the `accountId` validation block entirely. The credentials check in the try block now serves as the validation gate.

**Step 5: Simplify handleError**

Remove AWS-specific error cases from the `handleError` function since initialize-github no longer makes AWS calls. Remove:
- The `AccessDenied / AssumeRole` case (lines ~205-216)
- The `already exists` case (lines ~219-226) - this was for IAM user creation
- The `LimitExceeded` case (lines ~230-237) - this was for access key creation

Keep:
- The GitHub authentication error case
- The default error handler

The simplified `handleError`:
```typescript
function handleError(error: unknown, env: string): never {
  console.error('');

  if (!(error instanceof Error)) {
    console.error(pc.red('Error:') + ' Unknown error occurred');
    process.exit(1);
  }

  // GitHub authentication errors
  if (error.message.includes('authentication failed') || error.name === 'HttpError') {
    console.error(pc.red('Error: GitHub authentication failed'));
    console.error('');
    console.error('Ensure your Personal Access Token:');
    console.error('  1. Has "repo" scope enabled');
    console.error('  2. Belongs to the repository owner or has access');
    console.error('  3. Is not expired');
    console.error('');
    console.error('Create a new token at: https://github.com/settings/tokens/new');
    process.exit(1);
  }

  // Default error handling
  console.error(pc.red('Error:') + ` ${error.message}`);
  if (error.name) {
    console.error(pc.dim(`Error type: ${error.name}`));
  }
  process.exit(1);
}
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm no type errors.
2. Run `npm test` to confirm existing tests still pass.
3. Verify no imports from `../aws/` remain: `grep -r "../aws/" src/commands/initialize-github.ts` should return empty.
  </verify>
  <done>initialize-github has zero AWS/IAM imports, reads credentials from config.deploymentCredentials, pushes to GitHub with existing encryption and environment logic, shows helpful migration error for projects without credentials, and all GitHub-specific functionality (PAT prompt, env selection, secret encryption) is preserved.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm test` passes (existing tests unaffected)
3. `grep -r "../aws/" src/commands/initialize-github.ts` returns no matches
4. `initialize-github.ts` imports from `../github/secrets.js` and `../utils/project-context.js` only (plus standard library)
5. `initialize-github.ts` reads `config.deploymentCredentials?.[env]` for credentials
6. `initialize-github.ts` still calls `promptForGitHubPAT()` for PAT collection
7. `initialize-github.ts` still calls `setEnvironmentCredentials()` for GitHub secret pushing
8. `initialize-github.ts` shows clear error when deploymentCredentials is missing
</verification>

<success_criteria>
- initialize-github has zero imports from `../aws/` modules
- initialize-github reads credentials from `config.deploymentCredentials`
- GitHub PAT prompt, environment selection, and secret encryption all preserved
- Missing credentials produce helpful error directing to setup-aws-envs
- Migration case (deploymentUsers without credentials) is detected and explained
- TypeScript compiles without errors
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/18-architecture-simplification/18-02-SUMMARY.md`
</output>
