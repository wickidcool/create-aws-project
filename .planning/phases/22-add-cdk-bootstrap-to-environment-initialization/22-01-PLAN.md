---
phase: 22-add-cdk-bootstrap-to-environment-initialization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aws/cdk-bootstrap.ts
  - src/commands/setup-aws-envs.ts
  - src/__tests__/aws/cdk-bootstrap.spec.ts
autonomous: true

must_haves:
  truths:
    - "Running setup-aws-envs bootstraps CDK in every environment account after access key creation"
    - "Bootstrap uses admin credentials to assume OrganizationAccountAccessRole in each account"
    - "Bootstrap is idempotent - re-running setup-aws-envs does not fail on already-bootstrapped environments"
    - "Bootstrap failures produce clear error messages with the failing account and CDK output"
    - "Success summary shows bootstrap status for each environment"
  artifacts:
    - path: "src/aws/cdk-bootstrap.ts"
      provides: "bootstrapCDKEnvironment function and bootstrapAllEnvironments orchestrator"
      exports: ["bootstrapCDKEnvironment", "bootstrapAllEnvironments"]
      contains: "npx.*cdk.*bootstrap"
    - path: "src/__tests__/aws/cdk-bootstrap.spec.ts"
      provides: "Unit tests for bootstrap module"
      contains: "describe.*bootstrapCDKEnvironment"
    - path: "src/commands/setup-aws-envs.ts"
      provides: "Bootstrap step integrated after access key creation"
      contains: "bootstrapAllEnvironments"
  key_links:
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/aws/cdk-bootstrap.ts"
      via: "import and call bootstrapAllEnvironments"
      pattern: "import.*bootstrapAllEnvironments.*cdk-bootstrap"
    - from: "src/aws/cdk-bootstrap.ts"
      to: "execa"
      via: "npx cdk bootstrap subprocess"
      pattern: "execa.*npx.*cdk.*bootstrap"
    - from: "src/aws/cdk-bootstrap.ts"
      to: "@aws-sdk/client-sts"
      via: "STS AssumeRole for cross-account credentials"
      pattern: "AssumeRoleCommand|fromTemporaryCredentials"
---

<objective>
Add CDK bootstrap as the final step in setup-aws-envs, so every environment account is ready for CDK deployments after setup completes.

Purpose: Without bootstrapping, users would need to manually run `cdk bootstrap` in each account before their first CDK deployment. This automates that step, making the setup-aws-envs flow truly end-to-end: from root credentials all the way to deployment-ready environments.

Output: A new `src/aws/cdk-bootstrap.ts` module, unit tests, and integration into the setup-aws-envs command flow.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-add-cdk-bootstrap-to-environment-initialization/22-RESEARCH.md
@src/commands/setup-aws-envs.ts
@src/aws/iam.ts
@src/aws/root-credentials.ts
@src/utils/project-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CDK bootstrap module with unit tests</name>
  <files>src/aws/cdk-bootstrap.ts, src/__tests__/aws/cdk-bootstrap.spec.ts</files>
  <action>
Create `src/aws/cdk-bootstrap.ts` with two exported functions:

1. `bootstrapCDKEnvironment(options)` - Bootstraps a single environment account:
   - Parameters: `{ accountId: string, region: string, credentials: { accessKeyId: string, secretAccessKey: string } }`
   - Uses `execa` to run `npx cdk bootstrap aws://{accountId}/{region}` as a subprocess
   - Passes credentials via environment variables (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION`) to the subprocess env (spread `process.env` first, then override with credentials)
   - Passes flags: `--trust {accountId}`, `--cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess`, `--require-approval never`
   - Uses `{ all: true }` option on execa to capture combined stdout/stderr for error reporting
   - Returns `{ success: boolean, output: string }`
   - On error, catches the execa error and returns `{ success: false, output: error.all || error.message }`

2. `bootstrapAllEnvironments(options)` - Orchestrates bootstrap across all environments:
   - Parameters: `{ accounts: Record<string, string>, region: string, adminCredentials: { accessKeyId: string, secretAccessKey: string } | null, spinner: Ora }`
   - Iterates over ENVIRONMENTS ('dev', 'stage', 'prod') sequentially
   - For each environment:
     - Gets cross-account credentials: If `adminCredentials` is provided, use `STSClient` with admin credentials to `AssumeRole` on `arn:aws:iam::{accountId}:role/OrganizationAccountAccessRole`, then extract the temporary credentials. If `adminCredentials` is null, use `fromTemporaryCredentials` from `@aws-sdk/credential-providers` (same as existing cross-account pattern in setup-aws-envs, but resolve the credentials object to get actual key/secret values for env vars).
     - Actually: Simplify this. For the cross-account approach, use STS `AssumeRoleCommand` directly to get temporary credentials as strings. Import `STSClient` and `AssumeRoleCommand` from `@aws-sdk/client-sts`. Create an STS client with either admin credentials (if provided) or default credentials. Call AssumeRole for `OrganizationAccountAccessRole` in the target account. Extract `AccessKeyId`, `SecretAccessKey`, and `SessionToken` from the response. Pass all three as environment variables (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`, `AWS_REGION`) to the execa subprocess.
     - Updates spinner text: `Bootstrapping CDK in {env} account ({accountId})...`
     - Calls `bootstrapCDKEnvironment` with the resolved credentials
     - On success: `spinner.succeed(...)`
     - On failure: `spinner.fail(...)`, log the CDK output via `console.error(pc.red('Bootstrap error:'))` and the captured output, then throw the error
   - After all environments: logs summary line `pc.green('All environments bootstrapped for CDK deployments!')`

Important implementation notes:
- Import `execa` from `'execa'` (ESM import, already in project)
- Import `ora` type from `'ora'` for the spinner type (use `import type { Ora } from 'ora'`)
- Import `pc` from `'picocolors'`
- Import `STSClient`, `AssumeRoleCommand` from `'@aws-sdk/client-sts'` (already a transitive dependency via `@aws-sdk/credential-providers`)
- Follow the project's JSDoc comment style on all exports (see iam.ts for examples)
- The function should NOT check if already bootstrapped - bootstrap is idempotent, always safe to run

Create `src/__tests__/aws/cdk-bootstrap.spec.ts` with tests:
- Mock `execa` module using `jest.unstable_mockModule` (project uses ESM, see root-credentials.spec.ts for mocking pattern)
- Mock `@aws-sdk/client-sts` to mock STSClient and AssumeRoleCommand
- Test cases:
  1. `bootstrapCDKEnvironment` calls execa with correct args (verify npx, cdk, bootstrap, account/region, flags)
  2. `bootstrapCDKEnvironment` passes credentials as env vars (verify AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN, AWS_REGION in env)
  3. `bootstrapCDKEnvironment` returns success result on successful execution
  4. `bootstrapCDKEnvironment` returns failure result with output on error
  5. `bootstrapAllEnvironments` calls bootstrapCDKEnvironment for each environment
  6. `bootstrapAllEnvironments` assumes OrganizationAccountAccessRole for each account

Follow the test patterns in `src/__tests__/aws/root-credentials.spec.ts` for ESM mocking conventions.
  </action>
  <verify>
Run `npx jest src/__tests__/aws/cdk-bootstrap.spec.ts` - all tests pass.
Run `npx tsc --noEmit` - no type errors.
Verify `src/aws/cdk-bootstrap.ts` exports `bootstrapCDKEnvironment` and `bootstrapAllEnvironments`.
  </verify>
  <done>
`cdk-bootstrap.ts` module exists with both functions exported. All unit tests pass. TypeScript compiles without errors. The module handles cross-account credential resolution via STS AssumeRole and delegates to `npx cdk bootstrap` via execa.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire bootstrap into setup-aws-envs command</name>
  <files>src/commands/setup-aws-envs.ts</files>
  <action>
Modify `src/commands/setup-aws-envs.ts` to call CDK bootstrap after the access key creation loop completes:

1. Add import at top of file:
   ```typescript
   import { bootstrapAllEnvironments } from '../aws/cdk-bootstrap.js';
   ```

2. After the access key creation loop (after the `for (const env of ENVIRONMENTS)` block that creates deployment credentials, around line 551), add the bootstrap step:
   ```typescript
   // Bootstrap CDK in each environment account
   await bootstrapAllEnvironments({
     accounts,
     region: config.awsRegion,
     adminCredentials,
     spinner,
   });
   ```

3. Update the final success summary to include bootstrap status. After the existing summary table, before "Next: Push credentials to GitHub:", add:
   ```typescript
   console.log(pc.dim('CDK bootstrapped in all environment accounts.'));
   ```

4. Update the "Next" message to reflect that environments are now fully deployment-ready:
   Change the existing message from:
   ```
   'AWS setup complete with deployment credentials.'
   ```
   To:
   ```
   'AWS setup complete. All environments bootstrapped and ready for CDK deployments.'
   ```

Important:
- The bootstrap call goes INSIDE the existing try/catch block that wraps all AWS operations (so `handleAwsError` catches bootstrap failures too)
- The spinner variable is already available at this point in the code
- `adminCredentials` is already available (may be null if user ran with IAM credentials)
- `accounts` record is already populated with all account IDs
- `config.awsRegion` provides the correct region
- Do NOT modify any existing code above the insertion point (accounts, users, credentials loops are stable)
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Run `npx jest` - all existing tests still pass (no regressions).
Manually inspect `setup-aws-envs.ts` to confirm bootstrap call is placed after access key creation and before the success summary.
  </verify>
  <done>
`setup-aws-envs.ts` imports `bootstrapAllEnvironments` and calls it after access key creation. The success message reflects bootstrap completion. All existing tests pass without regressions. The complete setup-aws-envs flow is now: root detection -> org creation -> account creation -> deployment users -> access keys -> CDK bootstrap -> success summary.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx jest` passes all tests (existing + new bootstrap tests)
3. `src/aws/cdk-bootstrap.ts` exists with `bootstrapCDKEnvironment` and `bootstrapAllEnvironments` exports
4. `src/commands/setup-aws-envs.ts` imports and calls `bootstrapAllEnvironments` after access key creation
5. The execa call constructs the correct `npx cdk bootstrap aws://{accountId}/{region}` command with proper flags
6. Cross-account credentials are resolved via STS AssumeRole and passed as environment variables to the subprocess
</verification>

<success_criteria>
- CDK bootstrap module exists with proper cross-account credential handling
- Bootstrap is wired into setup-aws-envs as the final operational step
- All tests pass (new bootstrap tests + existing suite)
- TypeScript compiles without errors
- Bootstrap is idempotent (no check-before-run, just runs)
</success_criteria>

<output>
After completion, create `.planning/phases/22-add-cdk-bootstrap-to-environment-initialization/22-01-SUMMARY.md`
</output>
