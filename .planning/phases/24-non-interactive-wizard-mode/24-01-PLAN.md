---
phase: 24-non-interactive-wizard-mode
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config/non-interactive.ts
  - src/__tests__/config/non-interactive.spec.ts
autonomous: true

must_haves:
  truths:
    - "A JSON config with only `{\"name\": \"my-app\"}` produces a ProjectConfig with all wizard defaults applied"
    - "A JSON config with all fields specified produces a ProjectConfig matching every value"
    - "A JSON config missing `name` produces a clear error listing the failure and calls process.exit(1)"
    - "A JSON config with multiple invalid fields lists ALL validation failures, not just the first"
    - "A JSON config with `auth: \"none\"` silently drops any `authFeatures`"
    - "A non-existent config file path produces a clear file-not-found error"
    - "A config file with invalid JSON produces a clear parse error"
  artifacts:
    - path: "src/config/non-interactive.ts"
      provides: "Zod schema, loadNonInteractiveConfig() function"
      exports: ["NonInteractiveConfigSchema", "loadNonInteractiveConfig"]
    - path: "src/__tests__/config/non-interactive.spec.ts"
      provides: "Unit tests for schema validation and config loading"
      min_lines: 80
  key_links:
    - from: "src/config/non-interactive.ts"
      to: "src/types.ts"
      via: "returns ProjectConfig type"
      pattern: "ProjectConfig"
    - from: "src/config/non-interactive.ts"
      to: "src/validation/project-name.ts"
      via: "reuses validateProjectName()"
      pattern: "validateProjectName"
---

<objective>
Create the non-interactive config schema and loader using TDD. This module parses a JSON config file, validates it with Zod, applies defaults for omitted optional fields, and returns a fully-formed `ProjectConfig`.

Purpose: This is the core logic for NI-01 (config file), NI-03 (schema), NI-04 (defaults), and NI-05 (validation errors). It must work correctly before wiring into the CLI.
Output: `src/config/non-interactive.ts` with full test coverage in `src/__tests__/config/non-interactive.spec.ts`.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-non-interactive-wizard-mode/24-RESEARCH.md

@src/types.ts
@src/validation/project-name.ts
@src/__tests__/wizard.spec.ts
@src/prompts/platforms.ts
@src/prompts/auth.ts
@src/prompts/features.ts
@src/prompts/aws-config.ts
@src/prompts/theme.ts
@package.json
@jest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install zod and write failing tests for config schema and loader</name>
  <files>package.json, src/__tests__/config/non-interactive.spec.ts</files>
  <action>
1. Install zod: `npm install zod`

2. Create `src/__tests__/config/non-interactive.spec.ts` with the following test cases (all should FAIL since `src/config/non-interactive.ts` does not exist yet):

**Test structure:** Use `@jest/globals` imports (`describe, it, expect, jest, beforeEach`). Use `jest.unstable_mockModule` for picocolors mock (same pattern as `wizard.spec.ts`). Use dynamic import for the module under test. Mock `process.exit` to throw so tests can catch exit calls. Use `node:fs` `writeFileSync` + `node:os` `tmpdir()` + `node:path` `join()` to create temp config files.

**Test cases to write:**

Group: "schema defaults (NI-04)"
- "applies all defaults when only name is provided": Write `{"name": "my-app"}` to tmp file. Call `loadNonInteractiveConfig(tmpFile)`. Assert: `projectName === 'my-app'`, `platforms` deep-equals `['web', 'api']`, `auth.provider === 'none'`, `auth.features` deep-equals `[]`, `features` deep-equals `['github-actions', 'vscode-config']`, `awsRegion === 'us-east-1'`, `brandColor === 'blue'`.
- "uses specified values when all fields provided": Write full config `{"name":"full-app","platforms":["web","mobile","api"],"auth":"cognito","authFeatures":["social-login","mfa"],"features":["github-actions"],"region":"eu-west-1","brandColor":"purple"}` to tmp file. Assert each field matches.

Group: "schema validation (NI-05)"
- "exits with error when name is missing": Write `{}` to tmp file. Expect `process.exit` called with `1`. Verify `console.error` was called with output containing "name".
- "exits with error when name is empty string": Write `{"name":""}`. Expect exit(1).
- "exits with error for invalid platform value": Write `{"name":"x","platforms":["invalid"]}`. Expect exit(1).
- "exits with error for invalid auth provider": Write `{"name":"x","auth":"firebase"}`. Expect exit(1).
- "exits with error for invalid region": Write `{"name":"x","region":"mars-1"}`. Expect exit(1).
- "exits with error for invalid brand color": Write `{"name":"x","brandColor":"red"}`. Expect exit(1).
- "reports multiple validation failures at once": Write `{"platforms":["bad"],"auth":"bad","region":"bad"}` (missing name AND invalid fields). Expect exit(1). Verify `console.error` called multiple times (at least 3 field errors).

Group: "auth normalization"
- "silently drops authFeatures when auth is none": Write `{"name":"x","auth":"none","authFeatures":["social-login"]}`. Assert `auth.features` deep-equals `[]`.
- "preserves authFeatures when auth is cognito": Write `{"name":"x","auth":"cognito","authFeatures":["mfa"]}`. Assert `auth.features` deep-equals `['mfa']`.

Group: "file errors"
- "exits with error for non-existent file": Call `loadNonInteractiveConfig('/nonexistent/path.json')`. Expect exit(1).
- "exits with error for invalid JSON": Write "not json {{{" to tmp file. Expect exit(1).

Group: "project name validation"
- "exits with error for invalid npm package name": Write `{"name":"UPPERCASE"}` to tmp file. Expect exit(1) because npm package names cannot have uppercase.

**Important testing pattern:** Before each test, mock `process.exit` and `console.error`:
```typescript
jest.spyOn(process, 'exit').mockImplementation((() => { throw new Error('process.exit called'); }) as () => never);
jest.spyOn(console, 'error').mockImplementation(() => {});
```

3. Run tests with `npm test -- --testPathPattern non-interactive` to confirm they FAIL (module not found).
4. Commit: `test(24-01): add failing tests for non-interactive config schema`
  </action>
  <verify>
`npm test -- --testPathPattern non-interactive` runs and ALL tests fail with "Cannot find module" or similar import error (RED phase).
  </verify>
  <done>Test file exists at `src/__tests__/config/non-interactive.spec.ts` with 14+ test cases, all failing. Zod is installed in package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Implement config schema and loader to pass all tests</name>
  <files>src/config/non-interactive.ts</files>
  <action>
1. Create `src/config/non-interactive.ts` implementing:

**Imports:**
```typescript
import * as z from 'zod';
import { readFileSync } from 'node:fs';
import { resolve } from 'node:path';
import pc from 'picocolors';
import { validateProjectName } from '../validation/project-name.js';
import type { ProjectConfig } from '../types.js';
```

**Constants (as const tuples for Zod enum):**
- `VALID_PLATFORMS = ['web', 'mobile', 'api'] as const`
- `VALID_AUTH_PROVIDERS = ['none', 'cognito', 'auth0'] as const`
- `VALID_AUTH_FEATURES = ['social-login', 'mfa'] as const`
- `VALID_FEATURES = ['github-actions', 'vscode-config'] as const`
- `VALID_REGIONS = ['us-east-1', 'us-west-2', 'eu-west-1', 'eu-central-1', 'ap-northeast-1', 'ap-southeast-2'] as const`
- `VALID_BRAND_COLORS = ['blue', 'purple', 'teal', 'green', 'orange'] as const`

**Schema (exported):**
```typescript
export const NonInteractiveConfigSchema = z.object({
  name: z.string().min(1, { error: 'name is required' }),
  platforms: z.array(z.enum(VALID_PLATFORMS)).min(1).default(['web', 'api']),
  auth: z.enum(VALID_AUTH_PROVIDERS).default('none'),
  authFeatures: z.array(z.enum(VALID_AUTH_FEATURES)).default([]),
  features: z.array(z.enum(VALID_FEATURES)).default(['github-actions', 'vscode-config']),
  region: z.enum(VALID_REGIONS).default('us-east-1'),
  brandColor: z.enum(VALID_BRAND_COLORS).default('blue'),
});
```

NOTE on Zod v4: The `error:` parameter on `.min()` may need to be `{ message: 'name is required' }` instead of `{ error: '...' }`. Check what Zod v4 actually supports — if the tests fail on the error message format, adjust. The key behavior is that a missing/empty name produces a user-friendly error.

**Loader function (exported):**
```typescript
export function loadNonInteractiveConfig(configPath: string): ProjectConfig {
```

Steps inside:
1. `resolve(process.cwd(), configPath)` to get absolute path
2. `readFileSync(absolutePath, 'utf-8')` in try/catch — on fail: `console.error(pc.red('Error:') + ` Cannot read config file: ${absolutePath}`); process.exit(1);`
3. `JSON.parse(rawContent)` in try/catch — on fail: `console.error(pc.red('Error:') + ` Config file is not valid JSON: ${absolutePath}`); process.exit(1);`
4. `NonInteractiveConfigSchema.safeParse(rawData)` — on `!result.success`: iterate `result.error.issues`, print each as `  X fieldPath: message`, then `process.exit(1)`
5. Additional: `validateProjectName(result.data.name)` — if not `true`, print error and exit(1)
6. Map to `ProjectConfig`:
   - `projectName: cfg.name`
   - `platforms: cfg.platforms`
   - `awsRegion: cfg.region`
   - `features: cfg.features`
   - `brandColor: cfg.brandColor`
   - `auth: { provider: cfg.auth, features: cfg.auth === 'none' ? [] : cfg.authFeatures }`

2. Run `npm test -- --testPathPattern non-interactive` — all tests should PASS.

3. If any test fails, fix the implementation (not the tests) until all pass.

4. Commit: `feat(24-01): implement non-interactive config schema and loader`
  </action>
  <verify>
`npm test -- --testPathPattern non-interactive` — ALL tests pass (GREEN phase). Also run `npm test` to confirm no regressions in existing tests.
  </verify>
  <done>`src/config/non-interactive.ts` exports `NonInteractiveConfigSchema` and `loadNonInteractiveConfig()`. All 14+ tests pass. No regressions in existing test suites.</done>
</task>

</tasks>

<verification>
1. `npm test -- --testPathPattern non-interactive` — all tests pass
2. `npm test` — all existing tests still pass (no regressions)
3. `npm run build` — TypeScript compiles without errors
4. `loadNonInteractiveConfig` with `{"name":"x"}` returns ProjectConfig with all defaults
5. `loadNonInteractiveConfig` with invalid data calls process.exit(1) after printing all errors
</verification>

<success_criteria>
- zod is in package.json dependencies
- `src/config/non-interactive.ts` exports `NonInteractiveConfigSchema` and `loadNonInteractiveConfig`
- `src/__tests__/config/non-interactive.spec.ts` has 14+ test cases covering defaults, validation errors, auth normalization, and file errors
- All tests pass, all existing tests pass, TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/24-non-interactive-wizard-mode/24-01-SUMMARY.md`
</output>
