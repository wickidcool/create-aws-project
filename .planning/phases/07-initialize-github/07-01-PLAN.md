---
phase: 07-initialize-github
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/commands/initialize-github.ts
  - src/aws/iam.ts
autonomous: true

must_haves:
  truths:
    - "User can run initialize-github dev and environment gets configured"
    - "User can run initialize-github with no arg and select environment interactively"
    - "User gets validation error for invalid environment names"
    - "User gets error if account ID missing from config"
    - "Command creates IAM user in target account via cross-account access"
    - "Command configures GitHub Environment with AWS credentials"
  artifacts:
    - path: "src/commands/initialize-github.ts"
      provides: "Full command implementation"
      min_lines: 150
    - path: "src/aws/iam.ts"
      provides: "Cross-account IAM client factory"
      exports: ["createCrossAccountIAMClient"]
  key_links:
    - from: "src/commands/initialize-github.ts"
      to: "src/aws/iam.ts"
      via: "createCrossAccountIAMClient"
      pattern: "createCrossAccountIAMClient\\("
    - from: "src/commands/initialize-github.ts"
      to: "src/github/secrets.ts"
      via: "setEnvironmentCredentials"
      pattern: "setEnvironmentCredentials\\("
---

<objective>
Implement the initialize-github command that configures GitHub Environment with AWS credentials for a single environment (dev, stage, or prod).

Purpose: Enables per-environment GitHub deployment configuration after AWS accounts are created by setup-aws-envs
Output: Working command that creates IAM deployment user and configures GitHub secrets
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-initialize-github/07-CONTEXT.md
@.planning/phases/07-initialize-github/07-RESEARCH.md

# Existing code to reference
@src/commands/initialize-github.ts
@src/commands/setup-aws-envs.ts
@src/aws/iam.ts
@src/github/secrets.ts
@src/utils/project-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add STS dependency and cross-account IAM client</name>
  <files>
    - package.json
    - src/aws/iam.ts
  </files>
  <action>
1. Install `@aws-sdk/client-sts` dependency:
   ```bash
   npm install @aws-sdk/client-sts
   ```

2. Add `createCrossAccountIAMClient` function to `src/aws/iam.ts`:
   - Import `fromTemporaryCredentials` from `@aws-sdk/credential-providers`
   - Create function that accepts `region` and `targetAccountId`
   - Build role ARN: `arn:aws:iam::${targetAccountId}:role/OrganizationAccountAccessRole`
   - Return IAMClient configured with `fromTemporaryCredentials`:
     ```typescript
     export function createCrossAccountIAMClient(
       region: string,
       targetAccountId: string
     ): IAMClient {
       const roleArn = `arn:aws:iam::${targetAccountId}:role/OrganizationAccountAccessRole`;
       return new IAMClient({
         region,
         credentials: fromTemporaryCredentials({
           params: {
             RoleArn: roleArn,
             RoleSessionName: `create-aws-project-${Date.now()}`,
             DurationSeconds: 900,
           },
         }),
       });
     }
     ```
   - Export the new function

3. Update `createDeploymentUser` in `src/aws/iam.ts`:
   - Per CONTEXT.md: If IAM user already exists, show error telling user to delete manually
   - Change from "reusing" behavior to throwing error with guidance
   - Remove the early return that skips user creation
   - Error should show: IAM user "{name}" already exists. Delete manually before retrying.
  </action>
  <verify>
    - `npm run build` succeeds
    - `@aws-sdk/client-sts` appears in package.json dependencies
    - `createCrossAccountIAMClient` is exported from iam.ts
  </verify>
  <done>
    - STS dependency installed
    - Cross-account IAM client factory implemented
    - IAM user existence now errors instead of reusing
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement initialize-github command</name>
  <files>src/commands/initialize-github.ts</files>
  <action>
Replace the stub implementation with full command. Follow setup-aws-envs.ts patterns for consistency.

**Imports to add:**
- `ora` for spinners
- `prompts` for interactive input
- `execSync` from `node:child_process` for git remote
- `createCrossAccountIAMClient`, `createDeploymentUserWithCredentials` from `../aws/iam.js`
- `createGitHubClient`, `setEnvironmentCredentials`, `parseGitHubUrl` from `../github/secrets.js`

**Constants to add:**
```typescript
const GITHUB_ENV_NAMES: Record<string, string> = {
  dev: 'Development',
  stage: 'Staging',
  prod: 'Production',
};
```

**Functions to implement:**

1. `getGitRemoteOrigin()`: Parse git remote to extract owner/repo
   - Run `git remote get-url origin` via execSync
   - Parse with `parseGitHubUrl()` from github/secrets.ts
   - Return `{ owner, repo }` or null if fails
   - On non-GitHub URL, return null (caller will prompt manually)

2. `promptForGitHubPAT()`: Collect GitHub PAT via password prompt
   - Use prompts with type: 'password'
   - Validate token starts with `ghp_` or `github_pat_`
   - Message: "GitHub Personal Access Token (requires 'repo' scope):"
   - Exit on cancel

3. `promptForEnvironment(configuredEnvs: string[])`: Interactive env selection
   - Only show environments that have account IDs in config
   - Use prompts with type: 'select'
   - Message: "Select environment to configure:"
   - Exit on cancel

4. `handleError(error: unknown, env: string)`: Error handler (follow setup-aws-envs pattern)
   - Handle `AccessDenied` with AssumeRole context
   - Handle `EntityAlreadyExists` with deletion guidance
   - Handle GitHub auth errors
   - Handle `LimitExceeded` for access key limit
   - Default: show error message + error name

**Main function `runInitializeGitHub(args: string[])`:**

1. Call `requireProjectContext()` - validates project directory

2. Determine environment:
   - If `args[0]` provided: validate it
     - Must be lowercase (dev, stage, prod) - error on DEV, Dev, etc.
     - Must be in VALID_ENVIRONMENTS
   - If no arg: call `promptForEnvironment()` with environments that have account IDs

3. Validate account ID exists:
   ```typescript
   const accountId = context.config.accounts?.[env];
   if (!accountId) {
     console.error(pc.red('Error:') + ` No account ID for ${env}.`);
     console.error('');
     console.error('Run setup-aws-envs first to create environment accounts:');
     console.error(`  ${pc.cyan('npx create-aws-project setup-aws-envs')}`);
     process.exit(1);
   }
   ```

4. Get repository info:
   - Try `getGitRemoteOrigin()` first
   - If fails, prompt for `owner/repo` manually
   - Validate result before proceeding

5. Prompt for GitHub PAT (always interactive per CONTEXT.md)

6. Execute with ora spinner:
   ```typescript
   const spinner = ora(`Initializing ${env} environment...`).start();
   try {
     // Step 1: Create cross-account IAM client
     spinner.text = `Assuming role in ${env} account (${accountId})...`;
     const iamClient = createCrossAccountIAMClient(awsRegion, accountId);

     // Step 2: Create deployment user
     spinner.text = `Creating IAM deployment user...`;
     const credentials = await createDeploymentUserWithCredentials(
       iamClient,
       projectName,
       env,
       accountId
     );

     // Step 3: Configure GitHub
     const githubEnvName = GITHUB_ENV_NAMES[env];
     spinner.text = `Configuring GitHub Environment "${githubEnvName}"...`;
     const githubClient = createGitHubClient(pat);
     await setEnvironmentCredentials(
       githubClient,
       repoInfo.owner,
       repoInfo.repo,
       githubEnvName,
       credentials.accessKeyId,
       credentials.secretAccessKey
     );

     spinner.succeed(`Configured ${githubEnvName} environment`);
   } catch (error) {
     spinner.fail(`Failed to configure ${env} environment`);
     handleError(error, env);
   }
   ```

7. Show success summary:
   - IAM user ARN: `arn:aws:iam::${accountId}:user/deployment/${userName}`
   - GitHub Environment URL: `https://github.com/${owner}/${repo}/settings/environments`
   - Next steps:
     - Other environments to configure (list remaining envs with account IDs)
     - How to deploy: "Push to main branch to trigger deployment"
  </action>
  <verify>
    - `npm run build` succeeds
    - `npm run lint` passes
    - Command shows usage when run without project config
    - Command validates environment argument correctly
  </verify>
  <done>
    - Full command implementation replacing stub
    - Interactive environment selection when no arg
    - Cross-account IAM user creation
    - GitHub Environment configuration
    - Comprehensive error handling
    - Success summary with next steps
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration and build</name>
  <files>None (verification only)</files>
  <action>
1. Run full build: `npm run build`
2. Run linter: `npm run lint`
3. Run tests: `npm test`
4. Verify command routing works:
   - `node dist/index.js initialize-github` should show error about project context
   - Command stub behavior should be replaced

5. Check that all requirements are covered:
   - GH-01: User can run `initialize-github <env>` from inside generated project
   - GH-02: Command accepts environment name as required argument (dev, stage, prod)
   - GH-03: Command creates IAM deployment user for specified environment
   - GH-04: Command configures GitHub Environment with AWS credentials
   - GH-05: Command validates environment exists in project config before proceeding
  </action>
  <verify>
    - `npm run build` exits 0
    - `npm run lint` exits 0
    - `npm test` passes (no breaking changes to existing tests)
    - Running command without config shows "Not inside a project directory" error
  </verify>
  <done>
    - Build succeeds
    - Linting passes
    - Tests pass
    - Command integration verified
    - All requirements GH-01 through GH-05 covered
  </done>
</task>

</tasks>

<verification>
**Build verification:**
```bash
npm run build && npm run lint && npm test
```

**Manual integration test (requires AWS credentials and GitHub PAT):**
1. Create test project with `npx create-aws-project test-gh-init`
2. Run `setup-aws-envs` to create accounts (or mock config with account IDs)
3. Run `initialize-github dev` and verify:
   - IAM user created in dev account
   - GitHub Development environment created
   - AWS credentials stored as secrets

**Requirements coverage:**
- GH-01: Command runs from project directory (uses requireProjectContext)
- GH-02: Environment name required as argument or prompted interactively
- GH-03: IAM user created via createDeploymentUserWithCredentials
- GH-04: GitHub secrets set via setEnvironmentCredentials
- GH-05: Account ID validated before proceeding
</verification>

<success_criteria>
1. `npm run build` succeeds with no errors
2. `npm run lint` passes with no warnings
3. `npm test` passes (existing tests not broken)
4. Command shows helpful error when run outside project
5. Command shows error for invalid environment names
6. Command shows error when account ID missing
7. All GH-01 through GH-05 requirements implemented
</success_criteria>

<output>
After completion, create `.planning/phases/07-initialize-github/07-01-SUMMARY.md`
</output>
