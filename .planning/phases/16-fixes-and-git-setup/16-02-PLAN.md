---
phase: 16-fixes-and-git-setup
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/git/setup.ts
  - src/cli.ts
autonomous: true

must_haves:
  truths:
    - "After project generation, user is prompted for a GitHub repo URL which can be skipped to skip all git setup"
    - "When repo URL and PAT are provided, the generated project is git-initialized, committed, and pushed to the remote"
    - "If the specified remote repository does not exist, it is automatically created via GitHub API before pushing"
    - "Git setup is skipped entirely when user skips the repo URL prompt"
    - "The PAT does not persist in .git/config after push completes"
  artifacts:
    - path: "src/git/setup.ts"
      provides: "Git init, commit, repo creation, push, and prompt functions"
      exports: ["promptGitSetup", "setupGitRepository"]
    - path: "src/cli.ts"
      provides: "Git setup integration after project generation"
      contains: "setupGitRepository"
  key_links:
    - from: "src/cli.ts"
      to: "src/git/setup.ts"
      via: "import and call after writeConfigFile"
      pattern: "setupGitRepository|promptGitSetup"
    - from: "src/git/setup.ts"
      to: "src/github/secrets.ts"
      via: "import parseGitHubUrl and createGitHubClient"
      pattern: "parseGitHubUrl|createGitHubClient"
    - from: "src/git/setup.ts"
      to: "@octokit/rest"
      via: "repos.get, createForAuthenticatedUser, createInOrg"
      pattern: "repos\\.(get|createForAuthenticatedUser|createInOrg)"
    - from: "src/git/setup.ts"
      to: "child_process"
      via: "execSync for git CLI operations"
      pattern: "execSync.*git"
---

<objective>
Add optional GitHub repository setup after project generation.

Purpose: Users can push their generated project to GitHub in the same wizard flow, eliminating the manual git init + remote setup step. The feature is fully optional -- pressing Enter skips all git operations.
Output: New `src/git/setup.ts` module and updated `src/cli.ts` with git setup integration.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-fixes-and-git-setup/16-RESEARCH.md
@.planning/phases/16-fixes-and-git-setup/16-01-SUMMARY.md

@src/cli.ts
@src/github/secrets.ts
@src/commands/initialize-github.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git setup module with prompts, init, repo creation, and push</name>
  <files>src/git/setup.ts</files>
  <action>
Create `src/git/setup.ts` with these exported functions:

**1. `isGitAvailable(): boolean`**
- Try `execSync('git --version', { stdio: 'pipe' })` in a try/catch
- Return true if succeeds, false if throws
- Used to skip git prompts if git is not installed

**2. `promptGitSetup(): Promise<{ repoUrl: string; pat: string } | null>`**
- First check `isGitAvailable()`. If false, return null silently (no error, just skip).
- Print a section header: blank line, `pc.bold('GitHub Repository (optional)')`, `pc.dim('Push your project to a GitHub repository. Press Enter to skip.')`, blank line.
- Prompt for repo URL using `prompts` with `type: 'text'`, `name: 'repoUrl'`, `message: 'GitHub repository URL:'`. No `validate` -- empty string means skip.
- If repoUrl is empty/falsy after trim, return null (GIT-06: skip all git).
- Validate the URL by calling `parseGitHubUrl(repoUrl)` from `src/github/secrets.ts` in a try/catch. If it throws, print the error in red and return null.
- If URL valid, prompt for PAT using `prompts` with `type: 'password'`, `name: 'pat'`, `message: 'GitHub Personal Access Token:'`. Include validate function that checks: (a) not empty, (b) starts with `ghp_` or `github_pat_` (reuse pattern from `initialize-github.ts:88-90`).
- If PAT prompt is cancelled (user hits Ctrl+C), return null.
- Return `{ repoUrl: repoUrl.trim(), pat }`.

**3. `async function setupGitRepository(projectDir: string, repoUrl: string, pat: string): Promise<void>`**
This is the main orchestrator. Uses `ora` spinner for progress.

Steps:
a. Parse the URL: `const { owner, repo } = parseGitHubUrl(repoUrl);`
b. Create Octokit client: `const octokit = createGitHubClient(pat);` (import from `src/github/secrets.ts`)

c. **Check for git user config** -- try `execSync('git config user.name', { cwd: projectDir, stdio: 'pipe' })`. If it throws, set local config:
   - `execSync('git config user.name "create-aws-project"', { cwd: projectDir, stdio: 'pipe' })`
   - `execSync('git config user.email "noreply@create-aws-project"', { cwd: projectDir, stdio: 'pipe' })`
   Note: This must happen AFTER `git init` (step d), so reorder: do git init first, then check config.

d. **Git init** (GIT-03): Start spinner 'Initializing git repository...'
   - `execSync('git init -b main', { cwd: projectDir, stdio: 'pipe' })`
   - Then do the user config check from step (c)
   - `execSync('git add .', { cwd: projectDir, stdio: 'pipe' })`
   - `execSync('git commit -m "Initial commit from create-aws-project"', { cwd: projectDir, stdio: 'pipe' })`
   - Spinner succeed 'Git repository initialized'

e. **Ensure remote repo exists** (GIT-05): Start spinner 'Checking GitHub repository...'
   - Try `await octokit.rest.repos.get({ owner, repo })`
   - If 404: determine if owner is user or org:
     - `const { data: user } = await octokit.rest.users.getAuthenticated()`
     - If `owner === user.login`: `await octokit.rest.repos.createForAuthenticatedUser({ name: repo, private: true, auto_init: false })`
     - Else: `await octokit.rest.repos.createInOrg({ org: owner, name: repo, private: true, auto_init: false })`
     - Spinner succeed `Created repository ${owner}/${repo}`
   - If repo exists: Spinner succeed `Repository ${owner}/${repo} found`
   - If other error: Spinner fail, throw

f. **Push to remote** (GIT-04): Start spinner 'Pushing to GitHub...'
   - `const authUrl = \`https://${pat}@github.com/${owner}/${repo}.git\``
   - `execSync(\`git remote add origin ${authUrl}\`, { cwd: projectDir, stdio: 'pipe' })`
   - `execSync('git push -u origin main', { cwd: projectDir, stdio: 'pipe' })`
   - **CRITICAL: Remove PAT from .git/config immediately:**
   - `const cleanUrl = \`https://github.com/${owner}/${repo}.git\``
   - `execSync(\`git remote set-url origin ${cleanUrl}\`, { cwd: projectDir, stdio: 'pipe' })`
   - Spinner succeed `Pushed to ${owner}/${repo}`

g. Wrap the entire function body in a try/catch. On error:
   - If the spinner is active, call `spinner.fail()`
   - Print `pc.yellow('Warning:') + ' Git setup failed: ' + error.message`
   - Print `pc.dim('Your project was created successfully. You can set up git manually.')`
   - Do NOT throw -- git setup failure should not prevent the user from using their generated project.

Imports needed:
- `import { execSync } from 'node:child_process';`
- `import prompts from 'prompts';`
- `import ora from 'ora';`
- `import pc from 'picocolors';`
- `import { parseGitHubUrl, createGitHubClient } from '../github/secrets.js';`
  </action>
  <verify>
Run `npm run build` to confirm TypeScript compilation succeeds.
Verify the file exists and exports the right functions:
- `grep -n "export.*promptGitSetup" src/git/setup.ts`
- `grep -n "export.*setupGitRepository" src/git/setup.ts`
- `grep -n "remote set-url origin" src/git/setup.ts` confirms PAT cleanup
- `grep -n "git init -b main" src/git/setup.ts` confirms explicit branch name
- `grep -n "createInOrg" src/git/setup.ts` confirms org repo creation support
  </verify>
  <done>
`src/git/setup.ts` exists with exported `promptGitSetup` and `setupGitRepository` functions. Git operations use `execSync` with `cwd: projectDir` and `stdio: 'pipe'`. PAT is cleaned from remote URL after push. Repo creation handles both user and org owners. Git user config is set if not globally configured. Errors are caught and printed as warnings without aborting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate git setup into the create flow in cli.ts</name>
  <files>src/cli.ts</files>
  <action>
In `src/cli.ts`:

1. Add import at the top: `import { promptGitSetup, setupGitRepository } from './git/setup.js';`

2. In the `runCreate` function, after `writeConfigFile(outputDir, config);` (line ~174) and before the success message (line ~177), add the git setup flow:

```typescript
  // Optional: GitHub repository setup
  const gitResult = await promptGitSetup();
  if (gitResult) {
    await setupGitRepository(outputDir, gitResult.repoUrl, gitResult.pat);
  }
```

3. Remove the `process.exit(0)` at the end of `runCreate`. The process will exit naturally after the function completes. This is important because `process.exit(0)` would prevent any cleanup from running. If `process.exit(0)` must stay for some reason, keep it -- but place the git setup code BEFORE it.

Actually, looking at the existing code more carefully: `process.exit(0)` is on line 182 and is the current behavior. Keep it. Just ensure the git setup code is inserted between `writeConfigFile` and the success message print. The flow should be:

```
writeConfigFile(outputDir, config);

// Optional: GitHub repository setup
const gitResult = await promptGitSetup();
if (gitResult) {
  await setupGitRepository(outputDir, gitResult.repoUrl, gitResult.pat);
}

// Success message and next steps
console.log('');
console.log(pc.green('...') + ` Created ${pc.bold(config.projectName)} successfully!`);
printNextSteps(config.projectName, config.platforms);
process.exit(0);
```

This way, the success message prints AFTER git setup completes (or is skipped), giving the user a clean final output.
  </action>
  <verify>
Run `npm run build` to confirm TypeScript compilation succeeds.
Run `npm test` to confirm all existing tests pass.
Verify integration:
- `grep -n "promptGitSetup\|setupGitRepository" src/cli.ts` shows import and usage
- `grep -n "git/setup" src/cli.ts` shows the import path
  </verify>
  <done>
`src/cli.ts` imports `promptGitSetup` and `setupGitRepository` from `src/git/setup.ts`. After project generation and config file write, the user is prompted for optional git setup. If they provide a repo URL and PAT, the project is initialized, committed, and pushed. If they skip, no git operations occur. The success message prints after git setup completes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm test` passes (existing tests still green)
3. `src/git/setup.ts` exists with `promptGitSetup` and `setupGitRepository` exports
4. `src/cli.ts` calls `promptGitSetup()` after `writeConfigFile()` and before success message
5. `grep -n "remote set-url origin" src/git/setup.ts` confirms PAT is cleaned from .git/config
6. `grep -n "createInOrg" src/git/setup.ts` confirms org repo support
7. `grep -n "git init -b main" src/git/setup.ts` confirms explicit main branch
8. `grep -n "isGitAvailable" src/git/setup.ts` confirms git availability check
</verification>

<success_criteria>
- GIT-01: User is prompted for GitHub repo URL after generation (skippable)
- GIT-02: If URL provided, user is prompted for PAT
- GIT-03: Project directory is git-initialized with initial commit on `main` branch
- GIT-04: Remote origin set and initial commit pushed to GitHub
- GIT-05: If remote repo doesn't exist, it's created via GitHub API (handles both user and org)
- GIT-06: Pressing Enter at repo URL prompt skips all git operations
- PAT is not stored in .git/config after push
- Git setup failure prints warning but does not abort (project still usable)
- Build succeeds, tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-fixes-and-git-setup/16-02-SUMMARY.md`
</output>
