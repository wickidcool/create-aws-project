---
phase: 20-end-to-end-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/20-end-to-end-verification/20-TEST-PROTOCOL.md
autonomous: false

must_haves:
  truths:
    - "A comprehensive manual test protocol exists with exact steps for the full workflow"
    - "Test protocol covers project generation, setup-aws-envs with root credentials, and initialize-github"
    - "Test protocol includes idempotency verification (re-running commands produces no errors or duplicates)"
    - "Test protocol includes cleanup instructions for AWS resources"
    - "User has executed the test protocol and documented results"
  artifacts:
    - path: ".planning/phases/20-end-to-end-verification/20-TEST-PROTOCOL.md"
      provides: "Comprehensive manual test checklist for end-to-end workflow"
      min_lines: 100
    - path: ".planning/phases/20-end-to-end-verification/20-VERIFICATION-REPORT.md"
      provides: "Executed test results with pass/fail evidence"
      min_lines: 30
  key_links:
    - from: "20-TEST-PROTOCOL.md"
      to: "src/commands/setup-aws-envs.ts"
      via: "Tests exercise the setup-aws-envs command"
      pattern: "setup-aws-envs"
    - from: "20-TEST-PROTOCOL.md"
      to: "src/commands/initialize-github.ts"
      via: "Tests exercise the initialize-github command"
      pattern: "initialize-github"
---

<objective>
Create a comprehensive manual test protocol for the complete end-to-end workflow and execute it to verify Phase 17-19 features work together reliably.

Purpose: Phase 20 is a verification phase confirming that the full AWS setup workflow (root credentials -> admin user -> organization -> accounts -> deployment users -> credentials -> GitHub secrets) works end-to-end. AWS Organizations and real IAM operations cannot be mocked (LocalStack does not support Organizations), so manual testing with real AWS credentials is required.

Output: A reusable test protocol document and an executed verification report proving all success criteria pass.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-end-to-end-verification/20-RESEARCH.md
@src/commands/setup-aws-envs.ts
@src/commands/initialize-github.ts
@src/aws/root-credentials.ts
@src/aws/organizations.ts
@src/aws/iam.ts
@src/cli.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive manual test protocol</name>
  <files>.planning/phases/20-end-to-end-verification/20-TEST-PROTOCOL.md</files>
  <action>
Create a comprehensive manual test protocol document at `.planning/phases/20-end-to-end-verification/20-TEST-PROTOCOL.md` with the following structure:

**Header section:**
- Title, purpose, last-executed date placeholder, estimated duration (30-60 minutes)

**Prerequisites section:**
- AWS management account with root credentials (access key ID + secret access key)
- No existing AWS Organization in the account (or willingness to use existing one)
- GitHub account with a repository (or willingness to create one)
- GitHub Personal Access Token with `repo` scope
- Node.js 22+ installed
- This project built (`npm run build`)

**Test Case 1: Fresh Project Generation**
Steps:
1. Run `npx create-aws-project e2e-test-{timestamp}` with specific wizard choices (web+api, cognito, us-east-1)
2. Verify: project directory created, `.aws-starter-config.json` exists with correct values, `package.json` exists
Pass criteria: Project generated without errors, config file has expected shape

**Test Case 2: Setup AWS Environments (Root Credentials)**
Prerequisites: AWS root credentials configured in environment (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`)
Steps:
1. `cd` into generated project
2. Run `npx create-aws-project setup-aws-envs`
3. Enter email addresses for dev, stage, prod accounts when prompted
4. Wait for account creation (5-15 minutes total)
Verification:
- Root credentials detected (output shows "Root credentials detected")
- Admin IAM user created (output shows "Created admin user: {project}-admin")
- Organization created or existing one used
- All 3 environment accounts created
- Deployment users created in each account
- Access keys created for each deployment user
- `.aws-starter-config.json` updated with: accounts, deploymentUsers, adminUser, deploymentCredentials
Pass criteria: Command completes without errors, config file has all expected fields populated

**Test Case 3: Idempotent Re-run of setup-aws-envs**
Steps:
1. Run `npx create-aws-project setup-aws-envs` again in the same project
2. Observe output
Verification:
- No email prompts shown (accounts already exist)
- Admin user adoption message shown (not creation)
- All resources show "Using existing..." messages
- No errors or duplicate resources
- Config file unchanged (same account IDs, same credentials)
Pass criteria: Second run completes without errors, no duplicate resources created

**Test Case 4: Initialize GitHub Environment**
Prerequisites: GitHub repository URL and PAT ready
Steps:
1. Run `npx create-aws-project initialize-github dev`
2. Enter GitHub PAT when prompted
3. Verify GitHub Environment secrets
Verification:
- GitHub Environment "Development" created
- AWS_ACCESS_KEY_ID secret set
- AWS_SECRET_ACCESS_KEY secret set
- AWS_REGION secret set
- Secrets match values in config file
Pass criteria: Command completes, GitHub repository shows Development environment with secrets

**Test Case 5: Idempotent Re-run of initialize-github**
Steps:
1. Run `npx create-aws-project initialize-github dev` again
2. Enter GitHub PAT when prompted
Verification:
- Command completes without errors
- Secrets are updated (overwritten, not duplicated)
Pass criteria: Second run succeeds without errors

**Test Case 6: Full Deployment Verification (Optional)**
Steps:
1. Push generated project to GitHub
2. Trigger GitHub Actions workflow (push to main or create PR)
3. Monitor deployment to dev environment
Verification:
- GitHub Actions workflow triggered
- CDK bootstrap succeeds
- CDK deploy succeeds
- Application accessible at deployed URL
Pass criteria: Deployment pipeline completes successfully
Note: This test case is optional because it requires a fully configured AWS account with CDK bootstrap permissions

**Verification Report Template section:**
Include a template table for recording results:
| Test Case | Status | Evidence | Notes |
With rows for each test case, plus a success criteria checklist matching Phase 20's three criteria.

**Cleanup section:**
Document how to clean up test resources:
- Delete generated project directory
- Remove AWS accounts (note: AWS account closure takes 90 days)
- Delete IAM admin user and access keys
- Delete IAM deployment users and access keys
- Remove GitHub Environment secrets
- Delete GitHub repository if created for testing

**Important details for the protocol:**
- Use exact commands (copy-pasteable)
- Include expected output snippets where possible (e.g., "Root credentials detected", "Created admin user", "Using existing")
- Note timing expectations (account creation: 2-5 min each)
- Include troubleshooting tips for common issues (credential errors, rate limits, eventual consistency)
  </action>
  <verify>
File exists at `.planning/phases/20-end-to-end-verification/20-TEST-PROTOCOL.md`, has 100+ lines, contains all 6 test cases, includes prerequisites, cleanup, and verification report template sections.
  </verify>
  <done>
A comprehensive, copy-pasteable test protocol exists that covers the full end-to-end workflow, idempotency verification, and cleanup. Another person could pick up this document and execute the tests without needing additional context.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete manual test protocol for end-to-end verification of the v1.6 workflow. The protocol covers:
1. Fresh project generation
2. setup-aws-envs with root credentials (root detection, admin user, organization, accounts, deployment users, credentials)
3. Idempotent re-run of setup-aws-envs (no duplicate resources)
4. initialize-github (push credentials to GitHub secrets)
5. Idempotent re-run of initialize-github
6. Full deployment verification (optional)
  </what-built>
  <how-to-verify>
1. Review the test protocol at `.planning/phases/20-end-to-end-verification/20-TEST-PROTOCOL.md`
2. Execute the test protocol using real AWS root credentials and a GitHub repository
3. Record results in `.planning/phases/20-end-to-end-verification/20-VERIFICATION-REPORT.md` using the template provided
4. Verify all three Phase 20 success criteria pass:
   - Full workflow completes without errors
   - Generated project deploys (or credentials are correctly configured for deployment)
   - Re-running commands is idempotent

Note: You will need to build the project first (`npm run build`) and have AWS root credentials ready.
Expected duration: 30-60 minutes for test cases 1-5, additional time for optional test case 6.
  </how-to-verify>
  <resume-signal>Type "approved" with results summary, or describe issues found during testing</resume-signal>
</task>

</tasks>

<verification>
Phase 20 is verified when:
1. Test protocol document exists and is comprehensive (covers all workflow steps)
2. User has executed the test protocol with real AWS credentials
3. Verification report documents pass/fail for each test case
4. All three Phase 20 success criteria are confirmed:
   - Full workflow (generation -> setup-aws-envs -> initialize-github) completes without errors
   - Generated project has correct deployment configuration (credentials in config, secrets in GitHub)
   - Re-running setup-aws-envs and initialize-github is safe and idempotent
</verification>

<success_criteria>
- 20-TEST-PROTOCOL.md exists with 6 test cases covering the complete workflow
- User confirms test execution results (pass/fail for each test case)
- 20-VERIFICATION-REPORT.md created with documented evidence
- Phase 20 success criteria 1-3 all pass based on real execution
</success_criteria>

<output>
After completion, create `.planning/phases/20-end-to-end-verification/20-01-SUMMARY.md`
</output>
