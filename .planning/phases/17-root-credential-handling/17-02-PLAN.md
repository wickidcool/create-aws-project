---
phase: 17-root-credential-handling
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/commands/setup-aws-envs.ts
  - src/utils/project-context.ts
autonomous: true

must_haves:
  truths:
    - "Running setup-aws-envs with root credentials triggers root detection before any AWS organization or IAM operations"
    - "CLI creates admin user and switches to admin credentials transparently for all subsequent operations"
    - "Admin user info (userName + accessKeyId) is persisted to config file for idempotent re-runs"
    - "On re-run with existing adminUser in config, CLI skips root detection and admin creation entirely"
    - "Cross-account IAM clients use admin credentials instead of root credentials when admin user was created"
  artifacts:
    - path: "src/commands/setup-aws-envs.ts"
      provides: "Root detection integration and credential switching in setup flow"
      contains: "detectRootCredentials"
    - path: "src/utils/project-context.ts"
      provides: "Updated ProjectConfigMinimal with adminUser field"
      contains: "adminUser"
  key_links:
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/aws/root-credentials.ts"
      via: "import detectRootCredentials, createOrAdoptAdminUser"
      pattern: "import.*from.*root-credentials"
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/utils/project-context.ts"
      via: "reads adminUser from config to skip re-creation"
      pattern: "config\\.adminUser"
    - from: "src/commands/setup-aws-envs.ts"
      to: "@aws-sdk/client-iam"
      via: "Creates IAMClient with explicit admin credentials for cross-account operations"
      pattern: "new IAMClient.*credentials"
---

<objective>
Wire root credential detection into the setup-aws-envs command flow and update the config type to support admin user persistence.

Purpose: The root detection module from Plan 01 provides all the logic, but it is not connected to the CLI command yet. This plan inserts root detection at the start of setup-aws-envs, switches credentials when root is detected, persists admin user info to config, and skips re-creation on subsequent runs.

Output: Modified `src/commands/setup-aws-envs.ts` with root detection integration, modified `src/utils/project-context.ts` with adminUser config field.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-root-credential-handling/17-01-SUMMARY.md
@src/commands/setup-aws-envs.ts
@src/utils/project-context.ts
@src/aws/iam.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add adminUser field to config type and update setup-aws-envs imports</name>
  <files>src/utils/project-context.ts, src/commands/setup-aws-envs.ts</files>
  <action>
**1. Update ProjectConfigMinimal in `src/utils/project-context.ts`:**

Add `adminUser` optional field to the interface:

```typescript
export interface ProjectConfigMinimal {
  projectName: string;
  platforms: string[];
  awsRegion: string;
  configVersion?: string;
  accounts?: Record<string, string>;
  deploymentUsers?: Record<string, string>;
  adminUser?: {
    userName: string;
    accessKeyId: string;
  };
}
```

Note: Only store userName and accessKeyId (NOT secretAccessKey). The secret is only needed during the initial session. On re-runs, the presence of adminUser in config tells us to skip root detection -- the user should have switched to IAM credentials by then, or the admin user already exists and we adopt it.

**2. Update `src/commands/setup-aws-envs.ts`:**

Add new imports at the top (after existing imports):

```typescript
import {
  detectRootCredentials,
  createOrAdoptAdminUser,
  createIAMClient as createRootIAMClient,
} from '../aws/root-credentials.js';
import { createIAMClient } from '../aws/iam.js';
```

Wait -- `createIAMClient` is already exported from `iam.ts`. We should use that. The root-credentials module uses IAMClient directly. For the admin user creation, we need an IAMClient pointed at the management account (the current account, not cross-account). Use `createIAMClient(config.awsRegion)` from iam.ts for this.

Update imports to add `createIAMClient` from iam.ts (it is already exported but not currently imported in setup-aws-envs.ts):

```typescript
import {
  createIAMClient,
  createCrossAccountIAMClient,
  createOrAdoptDeploymentUser,
  createCDKDeploymentPolicy,
  attachPolicyToUser,
} from '../aws/iam.js';
```

Add import for root-credentials module:
```typescript
import {
  detectRootCredentials,
  createOrAdoptAdminUser,
} from '../aws/root-credentials.js';
```

Also add `IAMClient` type import from `@aws-sdk/client-iam` for the credential override pattern.
  </action>
  <verify>
`npx tsc --noEmit` passes. Verify adminUser field exists in ProjectConfigMinimal: `grep 'adminUser' src/utils/project-context.ts`.
  </verify>
  <done>
ProjectConfigMinimal has adminUser optional field with userName and accessKeyId. setup-aws-envs.ts has new imports for detectRootCredentials, createOrAdoptAdminUser, and createIAMClient. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Insert root detection and credential switching into setup-aws-envs flow</name>
  <files>src/commands/setup-aws-envs.ts</files>
  <action>
Modify the `runSetupAwsEnvs` function in `src/commands/setup-aws-envs.ts` to add root detection between project context validation and email collection.

**Insert root detection block after line ~246 (after the existing accounts check, before collectEmails):**

The new flow should be:

```
1. requireProjectContext()                    [existing - line 241]
2. Check existing accounts warning            [existing - lines 245-256]
3. >>> NEW: Root detection and admin user creation <<<
4. collectEmails()                            [existing - line 259]
5. Spinner + AWS operations                   [existing - lines 262+]
```

**Root detection logic (step 3):**

```typescript
// 3. Detect root credentials and create admin user if needed
let adminCredentials: { accessKeyId: string; secretAccessKey: string } | null = null;

if (config.adminUser) {
  // Admin user already created in a previous run - skip root detection
  console.log('');
  console.log(pc.yellow('Note:') + ` Admin user ${pc.cyan(config.adminUser.userName)} already configured.`);
  console.log(pc.dim('Using existing admin user. If you have switched to IAM credentials, root detection is skipped.'));
} else {
  // Check if current credentials are root
  try {
    const identity = await detectRootCredentials(config.awsRegion);

    if (identity.isRoot) {
      console.log('');
      console.log(pc.yellow('Root credentials detected.'));
      console.log('Creating admin IAM user for subsequent operations...');
      console.log('');

      // Create IAM client with current (root) credentials for management account
      const iamClient = createIAMClient(config.awsRegion);
      const adminResult = await createOrAdoptAdminUser(iamClient, config.projectName);

      // Store admin credentials for use in this session
      adminCredentials = {
        accessKeyId: adminResult.accessKeyId,
        secretAccessKey: adminResult.secretAccessKey,
      };

      // Persist admin user info to config (without secret key)
      const configContent = JSON.parse(readFileSync(configPath, 'utf-8'));
      configContent.adminUser = {
        userName: adminResult.userName,
        accessKeyId: adminResult.accessKeyId,
      };
      writeFileSync(configPath, JSON.stringify(configContent, null, 2) + '\n', 'utf-8');

      if (adminResult.adopted) {
        console.log(pc.green(`Adopted existing admin user: ${adminResult.userName}`));
      } else {
        console.log(pc.green(`Created admin user: ${adminResult.userName}`));
      }
      console.log(pc.dim('Admin credentials will be used for all subsequent AWS operations in this session.'));
      console.log('');
    }
  } catch (error) {
    // If STS call fails, let it propagate as an AWS error
    // This likely means credentials are not configured at all
    const spinner = ora('').start();
    spinner.fail('Failed to detect AWS credentials');
    handleAwsError(error);
  }
}
```

**Modify cross-account IAM client creation (inside the deployment users loop, ~line 322):**

When `adminCredentials` is not null, we need to create IAMClients that use the admin credentials instead of the default (root) credentials. The issue is that `createCrossAccountIAMClient` from iam.ts uses `fromTemporaryCredentials` which assumes a role -- but root credentials CANNOT assume `OrganizationAccountAccessRole`. Admin IAM user credentials CAN.

Replace the cross-account client creation inside the deployment users loop:

```typescript
// Instead of:
// const iamClient = createCrossAccountIAMClient(config.awsRegion, accountId);

// Use:
let iamClient: IAMClient;
if (adminCredentials) {
  // When admin credentials are available, create a cross-account client
  // that uses explicit admin credentials as the source for role assumption
  const { IAMClient: IAMClientClass } = await import('@aws-sdk/client-iam');
  const { fromTemporaryCredentials } = await import('@aws-sdk/credential-providers');
  const roleArn = `arn:aws:iam::${accountId}:role/OrganizationAccountAccessRole`;
  iamClient = new IAMClientClass({
    region: config.awsRegion,
    credentials: fromTemporaryCredentials({
      masterCredentials: {
        accessKeyId: adminCredentials.accessKeyId,
        secretAccessKey: adminCredentials.secretAccessKey,
      },
      params: {
        RoleArn: roleArn,
        RoleSessionName: `create-aws-project-${Date.now()}`,
        DurationSeconds: 900,
      },
    }),
  });
} else {
  iamClient = createCrossAccountIAMClient(config.awsRegion, accountId);
}
```

**IMPORTANT:** Do NOT use dynamic imports. Instead, add IAMClient to the existing `@aws-sdk/client-iam` import at the top of the file, and add `fromTemporaryCredentials` to a new import from `@aws-sdk/credential-providers`. Then use them directly in the inline client creation. This is cleaner and matches the pattern in iam.ts.

Add to top-level imports:
```typescript
import { IAMClient } from '@aws-sdk/client-iam';
import { fromTemporaryCredentials } from '@aws-sdk/credential-providers';
```

**Similarly for Organizations client:** The Organizations client also needs admin credentials when root is detected. Modify the Organizations client creation (~line 266):

```typescript
// When admin credentials available, create OrganizationsClient with explicit credentials
let client: OrganizationsClient;
if (adminCredentials) {
  client = new OrganizationsClient({
    region: 'us-east-1',
    credentials: {
      accessKeyId: adminCredentials.accessKeyId,
      secretAccessKey: adminCredentials.secretAccessKey,
    },
  });
} else {
  client = createOrganizationsClient('us-east-1');
}
```

Wait -- actually, root credentials CAN call Organizations APIs (CreateOrganization, CreateAccount). The issue is only with cross-account role assumption (STS AssumeRole fails for root). So we only need to switch credentials for the cross-account IAM client calls, not for Organizations. However, it is cleaner and safer to switch ALL operations to admin credentials once we have them. This avoids any edge cases where root is restricted.

Actually, let me reconsider. The Organizations API works fine with root. Cross-account role assumption does NOT work with root (that is the actual problem). So the credential switch is only critical for the cross-account IAM operations. But for consistency and to avoid mixing root + admin credentials in the same session, switch all clients to admin credentials.

To do this cleanly, also add `OrganizationsClient` import from `@aws-sdk/client-organizations` at the top, and conditionally create the Organizations client with admin credentials:

```typescript
import { OrganizationsClient } from '@aws-sdk/client-organizations';
```

Then in the try block (~line 266):
```typescript
let client: OrganizationsClient;
if (adminCredentials) {
  client = new OrganizationsClient({
    region: 'us-east-1',
    credentials: {
      accessKeyId: adminCredentials.accessKeyId,
      secretAccessKey: adminCredentials.secretAccessKey,
    },
  });
} else {
  client = createOrganizationsClient('us-east-1');
}
```

**Summary of changes to runSetupAwsEnvs:**
1. Add `adminCredentials` variable after context validation
2. Add root detection block (check config.adminUser first, then detectRootCredentials)
3. Persist adminUser to config when admin user is created
4. Use admin credentials for Organizations client when available
5. Use admin credentials with fromTemporaryCredentials masterCredentials for cross-account IAM clients when available
6. Keep existing flow unchanged when credentials are NOT root
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors
2. `npm run lint` passes (or pre-existing warnings only)
3. `npm test` passes (existing tests still green -- setup-aws-envs has no unit tests, but other tests must not break)
4. Read through the modified setup-aws-envs.ts and verify:
   - Root detection happens before collectEmails
   - adminUser is persisted to config
   - Cross-account clients use admin credentials when available
   - Organizations client uses admin credentials when available
   - Existing non-root flow is unchanged
  </verify>
  <done>
setup-aws-envs detects root credentials before any AWS operations. When root is detected, an admin IAM user is created (or adopted), credentials are switched for all subsequent operations, and adminUser is persisted to config. On re-run with adminUser in config, root detection is skipped. TypeScript compiles, lint passes, existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full project compiles
2. `npm test` -- all existing tests pass (no regressions)
3. `npm run lint` -- passes
4. Config type includes adminUser field
5. setup-aws-envs imports and uses detectRootCredentials, createOrAdoptAdminUser
6. Cross-account IAM client creation uses admin credentials when available
7. Code path for non-root credentials is unchanged (no behavior change for IAM user credentials)
</verification>

<success_criteria>
- Root detection occurs at the START of setup-aws-envs, before collectEmails and any AWS operations
- When root detected: admin user created, credentials switched, adminUser persisted to config
- When adminUser already in config: root detection skipped entirely
- Cross-account operations use admin credentials (not root) when admin user was created
- Non-root credential flow is completely unchanged
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/17-root-credential-handling/17-02-SUMMARY.md`
</output>
