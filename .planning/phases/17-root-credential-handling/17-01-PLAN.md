---
phase: 17-root-credential-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aws/root-credentials.ts
  - src/__tests__/aws/root-credentials.spec.ts
autonomous: true

must_haves:
  truths:
    - "detectRootCredentials calls STS GetCallerIdentity and returns caller identity with isRoot boolean"
    - "isRootUser correctly identifies root ARNs (ending with :root) vs IAM user ARNs"
    - "createOrAdoptAdminUser creates IAM user with AdministratorAccess when user does not exist"
    - "createOrAdoptAdminUser adopts existing admin user via ManagedBy tag instead of creating duplicate"
    - "createAccessKeyForAdmin checks existing key count and handles the 2-key AWS limit"
    - "retryWithBackoff retries failed operations with exponential delays for IAM eventual consistency"
  artifacts:
    - path: "src/aws/root-credentials.ts"
      provides: "Root credential detection, admin user creation, retry utility"
      exports: ["detectRootCredentials", "isRootUser", "createOrAdoptAdminUser", "createAccessKeyForAdmin", "retryWithBackoff", "CallerIdentity", "AdminUserResult"]
    - path: "src/__tests__/aws/root-credentials.spec.ts"
      provides: "Unit tests for root credential module"
      contains: "isRootUser"
  key_links:
    - from: "src/aws/root-credentials.ts"
      to: "@aws-sdk/client-sts"
      via: "STSClient.send(GetCallerIdentityCommand)"
      pattern: "GetCallerIdentityCommand"
    - from: "src/aws/root-credentials.ts"
      to: "@aws-sdk/client-iam"
      via: "IAMClient for admin user creation"
      pattern: "CreateUserCommand|AttachUserPolicyCommand"
    - from: "src/aws/root-credentials.ts"
      to: "src/aws/iam.ts"
      via: "Reuses getAccessKeyCount and createAccessKey for key management"
      pattern: "import.*from.*iam"
---

<objective>
Create the root credential detection and admin user management module for Phase 17.

Purpose: When users run `setup-aws-envs` with AWS root credentials, the CLI must detect this before any cross-account operations (which fail with root), create an admin IAM user in the management account, generate access keys, and provide credentials for subsequent operations. This module contains all the core logic; Plan 02 wires it into setup-aws-envs.

Output: `src/aws/root-credentials.ts` with exported functions and `src/__tests__/aws/root-credentials.spec.ts` with unit tests.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aws/iam.ts
@src/aws/organizations.ts
@src/utils/project-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create root credential detection and admin user module</name>
  <files>src/aws/root-credentials.ts</files>
  <action>
Create `src/aws/root-credentials.ts` with the following exports:

**1. Types:**
```typescript
export interface CallerIdentity {
  arn: string;
  accountId: string;
  userId: string;
  isRoot: boolean;
}

export interface AdminUserResult {
  userName: string;
  accessKeyId: string;
  secretAccessKey: string;
  adopted: boolean; // true if existing user was adopted, false if newly created
}
```

**2. `isRootUser(arn: string): boolean`**
- Returns true if ARN ends with `:root` (e.g., `arn:aws:iam::123456789012:root`)
- Returns false for IAM user ARNs (e.g., `arn:aws:iam::123456789012:user/admin`)
- Pure function, no AWS calls

**3. `detectRootCredentials(region: string): Promise<CallerIdentity>`**
- Creates STSClient with the given region
- Calls `GetCallerIdentityCommand` (no params needed)
- Returns CallerIdentity with `isRoot` set via `isRootUser(arn)`
- Import STSClient and GetCallerIdentityCommand from `@aws-sdk/client-sts` (already in package.json)
- Let errors propagate (caller handles)

**4. `retryWithBackoff<T>(fn: () => Promise<T>, options?: { maxRetries?: number; baseDelayMs?: number; description?: string }): Promise<T>`**
- Default maxRetries: 5, baseDelayMs: 1000
- On each retry: delay = baseDelayMs * 2^attempt (1s, 2s, 4s, 8s, 16s)
- Log retry attempts using picocolors dim text: `  Retrying {description} (attempt {n}/{max})...`
- Use a local `sleep` helper (same pattern as organizations.ts: `new Promise(resolve => setTimeout(resolve, ms))`)
- On final failure, throw the last error

**5. `createOrAdoptAdminUser(client: IAMClient, projectName: string): Promise<AdminUserResult>`**
- Admin user name: `${projectName}-admin`
- **Adopt existing path:** Check if user exists (GetUserCommand). If yes, check ManagedBy tag = 'create-aws-starter-kit' (ListUserTagsCommand). If managed by us, check access key count. If 0 keys, create new key. If 1+ keys, throw error explaining the admin user exists but we cannot retrieve the existing secret key -- user must delete existing keys or provide IAM credentials directly. Set `adopted: true`.
- If user exists but NOT managed by us, throw descriptive error.
- **Create new path:** CreateUserCommand with Path '/admin/', Tags: [{ Key: 'Purpose', Value: 'CLI Admin' }, { Key: 'ManagedBy', Value: 'create-aws-starter-kit' }]. Then AttachUserPolicyCommand with PolicyArn 'arn:aws:iam::aws:policy/AdministratorAccess'. Then wrap createAccessKeyForAdmin in retryWithBackoff (IAM eventual consistency). Set `adopted: false`.

**6. `createAccessKeyForAdmin(client: IAMClient, userName: string): Promise<{ accessKeyId: string; secretAccessKey: string }>`**
- Reuse `getAccessKeyCount` from `../aws/iam.js` to check key count before creating
- If 2 keys exist, throw error with actionable message (same pattern as iam.ts line 362-365)
- Call CreateAccessKeyCommand directly (do NOT reuse createAccessKey from iam.ts since that also logs -- keep admin key creation self-contained with its own logging)
- Return accessKeyId and secretAccessKey

**Implementation notes:**
- Follow existing import conventions: Node builtins first, external packages, internal modules
- Use `.js` extension for local imports (ESM)
- Use picocolors (imported as `pc`) for console output, matching existing patterns
- JSDoc all exported functions with @param and @returns
- Import IAMClient, CreateUserCommand, GetUserCommand, AttachUserPolicyCommand, CreateAccessKeyCommand, ListUserTagsCommand, ListAccessKeysCommand, NoSuchEntityException from '@aws-sdk/client-iam'
- Import STSClient, GetCallerIdentityCommand from '@aws-sdk/client-sts'
- Do NOT import from iam.ts for user creation logic (keep this module self-contained for admin user path). Only import getAccessKeyCount for the key limit check.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify the module compiles without type errors.
Verify the file exports the expected functions: `grep -c 'export' src/aws/root-credentials.ts` should show 6+ exports (2 interfaces + 5 functions or similar).
  </verify>
  <done>
src/aws/root-credentials.ts exists with all 6 exports (CallerIdentity, AdminUserResult, isRootUser, detectRootCredentials, retryWithBackoff, createOrAdoptAdminUser, createAccessKeyForAdmin). File compiles with no TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for root credential module</name>
  <files>src/__tests__/aws/root-credentials.spec.ts</files>
  <action>
Create `src/__tests__/aws/root-credentials.spec.ts` with tests for the pure/mockable functions.

**Test structure:**

```typescript
// Mock AWS SDK clients before imports
jest.mock('@aws-sdk/client-sts');
jest.mock('@aws-sdk/client-iam');
```

**Test group 1: isRootUser (pure function, no mocks needed)**
- `isRootUser('arn:aws:iam::123456789012:root')` returns true
- `isRootUser('arn:aws:iam::123456789012:user/admin')` returns false
- `isRootUser('arn:aws:iam::123456789012:user/deploy')` returns false
- `isRootUser('arn:aws:sts::123456789012:assumed-role/role-name/session')` returns false
- `isRootUser('')` returns false

**Test group 2: detectRootCredentials**
- Mock STSClient.send to return `{ Arn: 'arn:aws:iam::123456789012:root', Account: '123456789012', UserId: '123456789012' }`
- Verify returns CallerIdentity with isRoot: true
- Mock with IAM user ARN, verify isRoot: false
- Mock send to throw, verify error propagates

**Test group 3: retryWithBackoff**
- Function succeeds on first try: returns result, no retries
- Function fails twice then succeeds: returns result after retries (mock timers with jest.useFakeTimers or just accept real delays are tiny in test -- use baseDelayMs: 1 for tests)
- Function fails all retries: throws last error
- Verify retry count respects maxRetries option

**Test group 4: createOrAdoptAdminUser**
- **New user path:** Mock GetUserCommand to throw NoSuchEntityException, mock CreateUserCommand/AttachUserPolicyCommand/CreateAccessKeyCommand to succeed. Verify creates user with correct tags, attaches AdministratorAccess, creates access key. Verify adopted: false.
- **Adopt existing user path:** Mock GetUserCommand to succeed, mock ListUserTagsCommand to return ManagedBy tag, mock ListAccessKeysCommand to return 0 keys, mock CreateAccessKeyCommand to succeed. Verify adopted: true.
- **Existing user not managed by us:** Mock GetUserCommand to succeed, mock ListUserTagsCommand to return no matching tag. Verify throws error.
- **Existing user with existing keys:** Mock GetUserCommand to succeed, mock ListUserTagsCommand to return ManagedBy tag, mock ListAccessKeysCommand to return 1 key. Verify throws error about existing keys.

**Implementation notes:**
- Use jest.fn() for mocking AWS client send method
- Follow existing test patterns from project (see src/__tests__/ directory)
- Use `jest.useFakeTimers()` in retryWithBackoff tests to avoid real delays, OR use `baseDelayMs: 0` for fast tests
- Import from the source module using relative path with .js extension matching ESM convention
  </action>
  <verify>
Run `npm test -- --testPathPattern=root-credentials` and verify all tests pass. Expected: 12-16 test cases, all green.
  </verify>
  <done>
All unit tests pass. Coverage includes: isRootUser pure function (5 cases), detectRootCredentials with mocked STS (3 cases), retryWithBackoff behavior (3 cases), createOrAdoptAdminUser new/adopt/error paths (4 cases).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm test -- --testPathPattern=root-credentials` passes all tests
3. `npm run lint` passes (or only pre-existing warnings)
4. Module exports match the expected interface for Plan 02 integration
</verification>

<success_criteria>
- src/aws/root-credentials.ts compiles and exports: detectRootCredentials, isRootUser, createOrAdoptAdminUser, createAccessKeyForAdmin, retryWithBackoff, CallerIdentity, AdminUserResult
- All unit tests pass (12+ test cases)
- No new TypeScript errors introduced
- Module is self-contained and ready for integration in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/17-root-credential-handling/17-01-SUMMARY.md`
</output>
