---
phase: 01-aws-organizations-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified: [src/cli.ts, src/templates/tokens.ts, src/templates/types.ts, src/templates/manifest.ts]
autonomous: true
---

<objective>
Integrate AWS Organizations creation into CLI flow and add template tokens for account IDs.

Purpose: Connect the org wizard configuration to actual AWS API calls during project generation, and make account IDs available to templates for CDK deployment configuration.
Output: End-to-end org creation flow and template tokens for environment account IDs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/01-aws-organizations-foundation/01-01-SUMMARY.md
@.planning/phases/01-aws-organizations-foundation/01-02-SUMMARY.md

@src/cli.ts
@src/types.ts
@src/templates/tokens.ts
@src/templates/types.ts
@src/templates/manifest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate org creation into CLI flow</name>
  <files>src/cli.ts</files>
  <action>
Update cli.ts to call AWS Organizations creation when org is enabled:

1. Import from './aws/organizations.js':
   - createOrganizationsClient
   - checkExistingOrganization
   - createOrganization
   - createEnvironmentAccounts

2. After wizard completes and before generateProject is called, add org setup:
   ```
   if (config.org?.enabled) {
     // Org setup logic here
   }
   ```

3. Inside the org setup block:
   a. Print status: "Setting up AWS Organizations..."
   b. Create client: `createOrganizationsClient(config.awsRegion)`
   c. Check if already in organization: `checkExistingOrganization(client)`
   d. If not in org, create: `createOrganization(client)`
   e. Create environment accounts: `createEnvironmentAccounts(client, config.org.organizationName, config.org.accounts)`
   f. Update config.org.accounts with returned accountIds
   g. Print success with account IDs

4. Handle errors gracefully:
   - If AWS credentials not configured, print helpful error and exit
   - If insufficient permissions, suggest required IAM permissions
   - If account creation fails, report which account and why

5. Use picocolors for status output (green checkmarks for success, yellow for warnings, red for errors)

The org creation happens BEFORE project generation so account IDs are available for template tokens.
  </action>
  <verify>npm run build succeeds. CLI compiles without errors.</verify>
  <done>CLI creates AWS Organization and accounts when org.enabled is true. Account IDs populated back into config before project generation.</done>
</task>

<task type="auto">
  <name>Task 2: Add organization tokens to template system</name>
  <files>src/templates/tokens.ts, src/templates/types.ts, src/templates/manifest.ts</files>
  <action>
Update template token system to support organization account IDs with flexible environments:

1. In src/templates/tokens.ts, add new token constants:
   - ORG_ENABLED: 'ORG_ENABLED'
   - ORG_NAME: 'ORG_NAME'
   - ORG_ACCOUNTS_JSON: 'ORG_ACCOUNTS_JSON' (JSON array of {environment, accountId} objects)

   Also add common environment tokens for backward compatibility with typical setups:
   - DEV_ACCOUNT_ID: 'DEV_ACCOUNT_ID'
   - STAGE_ACCOUNT_ID: 'STAGE_ACCOUNT_ID'
   - PROD_ACCOUNT_ID: 'PROD_ACCOUNT_ID'

2. In src/templates/types.ts, update TokenValues interface to include:
   - ORG_ENABLED?: string ('true' or 'false')
   - ORG_NAME?: string
   - ORG_ACCOUNTS_JSON?: string (JSON string for templates that need full list)
   - DEV_ACCOUNT_ID?: string (empty if env not selected)
   - STAGE_ACCOUNT_ID?: string (empty if env not selected)
   - PROD_ACCOUNT_ID?: string (empty if env not selected)

3. In src/templates/manifest.ts, update deriveTokenValues function:
   - Add org tokens derivation from config.org:
     - ORG_ENABLED: config.org?.enabled ? 'true' : 'false'
     - ORG_NAME: config.org?.organizationName || ''
     - ORG_ACCOUNTS_JSON: JSON.stringify(config.org?.accounts || [])
     - For each of DEV/STAGE/PROD_ACCOUNT_ID: find matching environment in accounts array, return accountId or ''

This approach supports:
- Common environments via named tokens ({{DEV_ACCOUNT_ID}})
- Flexible environments via JSON (templates can parse {{ORG_ACCOUNTS_JSON}})
- Conditional blocks: // {{#if ORG_ENABLED}}...{{/if ORG_ENABLED}}
  </action>
  <verify>npm run build succeeds. npm test passes (token derivation tests may need updates).</verify>
  <done>Organization tokens support both common named environments and flexible JSON array for custom environments.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] CLI integration compiles and handles org config
- [ ] Token system includes all org-related tokens
- [ ] deriveTokenValues correctly extracts account IDs
- [ ] Error handling provides helpful messages for AWS issues
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- CLI creates org and accounts when enabled
- Account IDs populated before project generation
- Template tokens available for {{ORG_NAME}}, {{DEV_ACCOUNT_ID}}, {{ORG_ACCOUNTS_JSON}}, etc.
- Graceful error handling for AWS credential/permission issues
</success_criteria>

<output>
After completion, create `.planning/phases/01-aws-organizations-foundation/01-03-SUMMARY.md`
</output>
