---
phase: 04-cli-infrastructure-command-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/cli.ts
  - src/commands/setup-github.ts
autonomous: true

must_haves:
  truths:
    - "User runs `npx create-aws-project` and gets main wizard"
    - "User runs `npx create-aws-project setup-aws-envs` and CLI recognizes command"
    - "User runs `npx create-aws-project initialize-github dev` and CLI recognizes command"
    - "User runs `npx create-aws-project setup-github` and sees deprecation notice"
    - "User runs `npx create-aws-project --help` and sees new commands listed"
  artifacts:
    - path: "package.json"
      provides: "find-up dependency"
      contains: "find-up"
    - path: "src/cli.ts"
      provides: "Command routing logic"
      min_lines: 100
  key_links:
    - from: "src/cli.ts"
      to: "src/commands/setup-github.ts"
      via: "import showDeprecationNotice"
      pattern: "showDeprecationNotice"
---

<objective>
Refactor CLI to route commands and add deprecation notice for setup-github

Purpose: Establish command routing infrastructure for new commands (setup-aws-envs, initialize-github) while maintaining backward compatibility for existing create wizard and deprecating setup-github.

Output: Updated cli.ts with command routing, updated help text, deprecation notice for setup-github
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.3-ROADMAP.md
@.planning/phases/04-cli-infrastructure-command-routing/04-RESEARCH.md

# Current implementation
@src/index.ts
@src/cli.ts
@src/commands/setup-github.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install find-up dependency</name>
  <files>package.json</files>
  <action>
Install the find-up package for project context detection:

```bash
npm install find-up
```

This adds find-up v8.0.0+ to dependencies. The package is ESM-only and compatible with the project's `"type": "module"` configuration.
  </action>
  <verify>
Run `npm ls find-up` to confirm installation.
Check package.json contains `"find-up": "^8.0.0"` or similar in dependencies.
  </verify>
  <done>find-up appears in package.json dependencies and is installed in node_modules</done>
</task>

<task type="auto">
  <name>Task 2: Refactor cli.ts with command routing</name>
  <files>src/cli.ts</files>
  <action>
Refactor src/cli.ts to implement command routing pattern from research. Keep the existing run() function but restructure it:

1. **Keep existing functions**: getVersion(), printWelcome(), printNextSteps() remain unchanged

2. **Update printHelp()** to list new commands:
```
Commands:
  (default)           Create a new project (interactive wizard)
  setup-aws-envs      Set up AWS Organizations and environment accounts
  initialize-github   Configure GitHub Environment for deployment
  setup-github        [DEPRECATED] Use initialize-github instead

Options:
  --help, -h          Show this help message
  --version, -v       Show version number
```

3. **Refactor run() function** to use command routing:
- Parse args with `process.argv.slice(2)`
- Handle --help and --version first (existing logic)
- Find first non-flag argument as command name
- Collect remaining args for command
- Route to appropriate handler:
  - `undefined` or unknown -> runCreate() (existing wizard flow)
  - `setup-aws-envs` -> placeholder that logs "setup-aws-envs command (coming in Phase 6)"
  - `initialize-github` -> placeholder that logs "initialize-github command (coming in Phase 7)"
  - `setup-github` -> call showDeprecationNotice() from commands/setup-github.ts

4. **Extract wizard flow into runCreate()** function:
- Move the existing wizard + organizations + project generation logic from run() into a new async function `runCreate(args: string[])`
- This keeps the main wizard logic isolated and ready for Phase 5 refactoring

5. **Import showDeprecationNotice** from commands/setup-github.ts (will create in Task 3)

IMPORTANT ESM considerations:
- Keep using `import.meta.url` with `fileURLToPath` for path resolution (already in use)
- All imports use .js extension (already in use)
  </action>
  <verify>
Run `npm run build` to verify TypeScript compilation succeeds.
Verify no type errors in cli.ts.
  </verify>
  <done>
cli.ts compiles successfully with:
- Command routing in run() function
- runCreate() extracted function with existing wizard logic
- Updated printHelp() showing new commands
- Placeholder handlers for setup-aws-envs and initialize-github
- Import for showDeprecationNotice from commands/setup-github.ts
  </done>
</task>

<task type="auto">
  <name>Task 3: Add deprecation notice to setup-github</name>
  <files>src/commands/setup-github.ts</files>
  <action>
Add a showDeprecationNotice() function to src/commands/setup-github.ts and export it:

```typescript
/**
 * Shows deprecation notice for the old setup-github command
 * Exits with code 1 to indicate user should use new command
 */
export function showDeprecationNotice(): never {
  console.log('');
  console.log(pc.yellow('DEPRECATED:') + ' The setup-github command has been replaced.');
  console.log('');
  console.log('Use the new per-environment command instead:');
  console.log('');
  console.log(`  ${pc.cyan('npx create-aws-project initialize-github <env>')}`);
  console.log('');
  console.log('Where <env> is one of: dev, stage, prod');
  console.log('');
  console.log('Example workflow:');
  console.log(`  1. ${pc.cyan('npx create-aws-project setup-aws-envs')}     # Create AWS accounts`);
  console.log(`  2. ${pc.cyan('npx create-aws-project initialize-github dev')}  # Configure dev`);
  console.log(`  3. ${pc.cyan('npx create-aws-project initialize-github prod')} # Configure prod`);
  console.log('');
  console.log(pc.dim('The new approach provides better error isolation per environment.'));

  process.exit(1);
}
```

Add this function near the top of the file (after imports) and export it alongside runSetupGitHub.

Keep the existing runSetupGitHub() function intact - it's not being removed, just deprecated. The deprecation notice gives users the path forward.
  </action>
  <verify>
Run `npm run build` to verify compilation.
Run `node dist/index.js setup-github` and verify deprecation message appears.
  </verify>
  <done>
showDeprecationNotice() exported from setup-github.ts.
Running `setup-github` command shows deprecation message with migration instructions.
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify the CLI routing works:

```bash
# Build the project
npm run build

# Test backward compatibility - should show wizard banner
node dist/index.js --help

# Test deprecated command - should show deprecation notice
node dist/index.js setup-github

# Test new command placeholders - should show placeholder message
node dist/index.js setup-aws-envs
node dist/index.js initialize-github dev

# Verify version flag still works
node dist/index.js --version
```
</verification>

<success_criteria>
1. npm run build completes without errors
2. `--help` shows updated command list including setup-aws-envs, initialize-github, and deprecated setup-github
3. Running with no args still launches wizard (print Welcome banner)
4. `setup-github` command shows deprecation notice and exits with code 1
5. `setup-aws-envs` and `initialize-github` commands recognized (placeholder output)
6. find-up package installed and listed in package.json
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-infrastructure-command-routing/04-01-SUMMARY.md`
</output>
