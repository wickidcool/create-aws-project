---
phase: 25-non-interactive-setup-aws-envs
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/commands/setup-aws-envs.ts
autonomous: true

must_haves:
  truths:
    - "setup-aws-envs --config aws.json with {email:'owner@example.com'} runs the full AWS flow using derived emails without any interactive prompts"
    - "Derived emails are printed for transparency before AWS operations begin"
    - "collectEmails() is never called when --config is provided"
    - "GitHub setup auto-runs via runInitializeGitHub(['--all']) after AWS completes"
    - "GitHub setup failure produces a warning but does not exit non-zero"
    - "Running setup-aws-envs without --config works exactly as before (no regression)"
    - "--config without a path argument prints error and exits 1"
  artifacts:
    - path: "src/commands/setup-aws-envs.ts"
      provides: "Non-interactive AWS setup path with --config detection and runSetupAwsEnvsNonInteractive()"
      contains: "runSetupAwsEnvsNonInteractive"
  key_links:
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/config/non-interactive-aws.ts"
      via: "import loadSetupAwsEnvsConfig, deriveEnvironmentEmails"
      pattern: "import.*loadSetupAwsEnvsConfig.*from.*non-interactive-aws"
    - from: "src/commands/setup-aws-envs.ts"
      to: "runInitializeGitHub"
      via: "unconditional call in non-interactive path"
      pattern: "runInitializeGitHub\\(\\['--all'\\]\\)"
---

<objective>
Wire the --config flag into setup-aws-envs.ts: detect the flag, load config, derive emails, run the full AWS setup flow without prompts, and auto-invoke GitHub setup at the end.

Purpose: Complete NI-07, NI-08, NI-09 — making setup-aws-envs fully non-interactive when --config is provided.
Output: Modified `src/commands/setup-aws-envs.ts` with non-interactive code path.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-non-interactive-setup-aws-envs/25-RESEARCH.md
@.planning/phases/25-non-interactive-setup-aws-envs/25-01-SUMMARY.md

# Source file to modify:
@src/commands/setup-aws-envs.ts

# Phase 24 CLI wiring pattern to follow:
@src/cli.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --config detection and runSetupAwsEnvsNonInteractive() to setup-aws-envs.ts</name>
  <files>src/commands/setup-aws-envs.ts</files>
  <action>
    Modify `src/commands/setup-aws-envs.ts` to add non-interactive mode:

    1. **Add imports** at top of file:
       ```typescript
       import { loadSetupAwsEnvsConfig, deriveEnvironmentEmails } from '../config/non-interactive-aws.js';
       ```

    2. **Rename `_args` to `args`** in `runSetupAwsEnvs()` function signature (line 263):
       ```typescript
       export async function runSetupAwsEnvs(args: string[]): Promise<void> {
       ```

    3. **Add --config detection** as the FIRST thing inside `runSetupAwsEnvs()`, before `requireProjectContext()`:
       ```typescript
       const configFlagIndex = args.findIndex(arg => arg === '--config');
       if (configFlagIndex !== -1) {
         const configPath = args[configFlagIndex + 1];
         if (!configPath || configPath.startsWith('--')) {
           console.error(pc.red('Error:') + ' --config requires a path argument');
           console.error('  Example: npx create-aws-project setup-aws-envs --config aws.json');
           process.exit(1);
         }
         await runSetupAwsEnvsNonInteractive(configPath);
         return;
       }
       ```

    4. **Create `runSetupAwsEnvsNonInteractive()` async function** (place it above `runSetupAwsEnvs` or below it, before any non-exported helpers). This function replicates the interactive flow but with these changes:

       a. Load and validate config: `const awsConfig = loadSetupAwsEnvsConfig(configPath);`

       b. Call `requireProjectContext()` to get project config and path (same as interactive).

       c. Derive emails: `const emails = deriveEnvironmentEmails(awsConfig.email, ENVIRONMENTS);`

       d. Print derived emails for transparency:
          ```typescript
          console.log('');
          console.log('Derived environment emails:');
          for (const [env, email] of Object.entries(emails)) {
            console.log(`  ${pc.cyan(env)}: ${email}`);
          }
          console.log('');
          ```

       e. Replicate the ENTIRE interactive flow from `runSetupAwsEnvs()` starting at step 2 (existing accounts check) through step "Bootstrap CDK" and "Final success summary" — but with these specific changes:
          - Where interactive calls `collectEmails()` (line 406), use the pre-derived `emails` directly. Do NOT call `collectEmails()`.
          - Where interactive has the spinner.stop()/collectEmails()/spinner.start() dance (lines 400-413), in non-interactive mode: keep spinner active, use derived emails directly. When `environmentsNeedingCreation.length > 0`, just start the spinner and continue (emails already known). When `environmentsNeedingCreation.length === 0`, print the "all accounts exist" message as interactive does.
          - The root credentials detection (step 3 in interactive), Organizations client creation, account creation loops, IAM user creation loops, access key creation loops, CDK bootstrap, and summary table are ALL identical — copy them exactly.

       f. After the success summary, auto-run GitHub setup (instead of the interactive prompt at lines 580-604):
          ```typescript
          console.log('Setting up GitHub environments...');
          try {
            await runInitializeGitHub(['--all']);
          } catch (error) {
            const msg = error instanceof Error ? error.message : String(error);
            console.warn(pc.yellow('Warning:') + ` GitHub setup failed: ${msg}`);
            console.warn('AWS setup completed successfully. Run initialize-github manually:');
            console.warn(`  ${pc.cyan('npx create-aws-project initialize-github --all')}`);
          }
          ```

       g. End with `process.exit(0);` to prevent any fallthrough (matching Phase 24 pattern).

    IMPORTANT NOTES:
    - The `handleAwsError()` function is used in the non-interactive path's try/catch for AWS errors (same as interactive). But do NOT use it for the GitHub step — GitHub errors get the warning treatment per CONTEXT.md.
    - The non-interactive function wraps the AWS operations in the same try/catch + handleAwsError pattern as the interactive flow.
    - Keep all existing interactive code COMPLETELY UNCHANGED. The only modification to the existing `runSetupAwsEnvs()` is: (a) rename `_args` to `args`, (b) add the --config detection block at the top.
    - Per research Pitfall 3: `runInitializeGitHub` may call `process.exit(1)` internally for auth failures, which cannot be caught by try/catch. This is acceptable — the try/catch catches thrown JavaScript errors (network, API); process.exit bypasses it. Document this as a known limitation in the code comment.
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    npx jest --testPathPatterns non-interactive-aws
    npx jest
    ```
    TypeScript compiles clean. Non-interactive-aws tests still pass. Full suite passes. No regressions.
  </verify>
  <done>
    - `setup-aws-envs --config aws.json` routes to `runSetupAwsEnvsNonInteractive()` which loads config, derives emails, runs full AWS flow, auto-invokes GitHub setup
    - `setup-aws-envs` without --config works identically to before (no regression)
    - `--config` without a path exits 1 with usage hint
    - TypeScript compiles, all tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end verification of non-interactive setup-aws-envs</name>
  <files></files>
  <action>
    Verify the complete implementation against Phase 25 success criteria. This is verification only, no file changes.

    1. **SC-1: Non-interactive mode works with minimal config**
       Run `npx tsc --noEmit` to verify the full non-interactive code path compiles.
       Read `src/commands/setup-aws-envs.ts` and verify:
       - `--config` detection is the first thing in `runSetupAwsEnvs()`
       - `runSetupAwsEnvsNonInteractive()` calls `loadSetupAwsEnvsConfig()` then `requireProjectContext()`
       - `collectEmails()` is NOT called anywhere in the non-interactive path
       - The interactive flow is completely unchanged (no modifications below the --config detection block)

    2. **SC-2: Email derivation works correctly**
       Run `npx jest --testPathPatterns non-interactive-aws` and confirm all email derivation tests pass:
       - Standard dev/stage/prod derivation
       - Plus alias handling
       - Subdomain handling

    3. **SC-3: No regression in interactive mode**
       Verify that `runSetupAwsEnvs()` only has two changes from the original:
       - `_args` renamed to `args`
       - `--config` detection block added at top (early return)
       Everything else in the interactive path is untouched.

    4. **SC-4: GitHub auto-setup with graceful failure**
       Read the non-interactive function and verify:
       - `runInitializeGitHub(['--all'])` is called unconditionally after AWS success
       - The call is wrapped in try/catch
       - Catch block prints warning (not error), includes manual recovery command
       - Does NOT call `handleAwsError()` for GitHub failures

    5. **Full test suite**
       Run `npx jest` and confirm all tests pass (should be 160+ existing + new non-interactive-aws tests).
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    npx jest
    ```
    Zero errors. All tests pass.
  </verify>
  <done>
    All three Phase 25 success criteria verified:
    - SC-1: setup-aws-envs --config aws.json uses derived emails, no prompts
    - SC-2: Email derivation: owner@example.com -> owner-dev@, owner-stage@, owner-prod@
    - SC-3: Interactive mode unchanged (no regression)
  </done>
</task>

</tasks>

<verification>
Phase 25 complete when:
1. `npx tsc --noEmit` compiles clean
2. `npx jest` — all tests pass (no regressions)
3. `src/commands/setup-aws-envs.ts` has --config detection routing to non-interactive path
4. Non-interactive path derives emails, runs full AWS flow, auto-invokes GitHub setup
5. Interactive path is completely unchanged
</verification>

<success_criteria>
- Running `setup-aws-envs --config aws.json` with `{"email": "owner@example.com"}` routes to non-interactive path
- Per-environment emails derived: owner-dev@, owner-stage@, owner-prod@
- Full AWS flow (org, accounts, IAM, CDK) runs with derived emails, no prompts
- GitHub setup auto-invoked; failures produce warning not error
- Running without --config uses interactive path unchanged
- All tests pass, TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/25-non-interactive-setup-aws-envs/25-02-SUMMARY.md`
</output>
