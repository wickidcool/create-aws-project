---
phase: 25-non-interactive-setup-aws-envs
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/config/non-interactive-aws.ts
  - src/__tests__/config/non-interactive-aws.spec.ts
autonomous: true

must_haves:
  truths:
    - "deriveEnvironmentEmails('owner@example.com', ['dev','stage','prod']) returns {dev:'owner-dev@example.com', stage:'owner-stage@example.com', prod:'owner-prod@example.com'}"
    - "loadSetupAwsEnvsConfig with {email:'owner@example.com'} returns {email:'owner@example.com'}"
    - "loadSetupAwsEnvsConfig with {} exits non-zero with error listing 'email' as missing"
    - "loadSetupAwsEnvsConfig with {email:'notanemail'} (no @) exits non-zero with email format error"
    - "loadSetupAwsEnvsConfig strips unknown keys silently"
    - "deriveEnvironmentEmails handles plus aliases: user+tag@co.com -> user+tag-dev@co.com"
    - "deriveEnvironmentEmails handles subdomains: admin@sub.example.com -> admin-dev@sub.example.com"
  artifacts:
    - path: "src/config/non-interactive-aws.ts"
      provides: "SetupAwsEnvsConfigSchema, SetupAwsEnvsConfig type, loadSetupAwsEnvsConfig(), deriveEnvironmentEmails()"
      exports: ["SetupAwsEnvsConfigSchema", "SetupAwsEnvsConfig", "loadSetupAwsEnvsConfig", "deriveEnvironmentEmails"]
    - path: "src/__tests__/config/non-interactive-aws.spec.ts"
      provides: "Unit tests for schema validation and email derivation"
      min_lines: 60
  key_links:
    - from: "src/config/non-interactive-aws.ts"
      to: "zod"
      via: "z.object schema with safeParse"
      pattern: "SetupAwsEnvsConfigSchema\\.safeParse"
    - from: "src/config/non-interactive-aws.ts"
      to: "node:fs"
      via: "readFileSync for config file"
      pattern: "readFileSync"
---

<objective>
TDD: Create the Zod config schema, loader function, and email derivation utility for non-interactive setup-aws-envs mode.

Purpose: Provide the validated config loading and email derivation that Plan 02 will wire into setup-aws-envs.ts. This mirrors Phase 24's Plan 01 (schema + loader) exactly.
Output: `src/config/non-interactive-aws.ts` with exports + comprehensive test file.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-non-interactive-setup-aws-envs/25-RESEARCH.md

# Phase 24 implementation to replicate pattern from:
@src/config/non-interactive.ts
@src/__tests__/config/non-interactive.spec.ts
</context>

<feature>
  <name>Setup-aws-envs config schema and email derivation</name>
  <files>src/config/non-interactive-aws.ts, src/__tests__/config/non-interactive-aws.spec.ts</files>
  <behavior>
    Email derivation:
    - deriveEnvironmentEmails('owner@example.com', ['dev','stage','prod']) -> {dev:'owner-dev@example.com', stage:'owner-stage@example.com', prod:'owner-prod@example.com'}
    - deriveEnvironmentEmails('user+tag@company.com', ['dev']) -> {dev:'user+tag-dev@company.com'}
    - deriveEnvironmentEmails('admin@sub.example.com', ['dev']) -> {dev:'admin-dev@sub.example.com'}

    Schema validation:
    - {email:'owner@example.com'} -> valid, returns {email:'owner@example.com'}
    - {} -> invalid, exits 1, error mentions 'email'
    - {email:''} -> invalid, exits 1
    - {email:'notanemail'} -> invalid, exits 1 (no @ sign)
    - {email:'valid@test.com', unknown:'x'} -> valid, strips 'unknown' key
    - Non-existent file path -> exits 1 with file error
    - Invalid JSON content -> exits 1 with JSON error
  </behavior>
  <implementation>
    RED phase: Create test file `src/__tests__/config/non-interactive-aws.spec.ts` following exact Phase 24 test patterns:
    - Mock picocolors with jest.unstable_mockModule
    - Dynamic import after mocking
    - writeTempConfig helper using os.tmpdir()
    - Mock process.exit to throw
    - Mock console.error to suppress output
    - Test groups: email derivation (3+ cases), schema defaults (1 case), schema validation (4+ cases: missing email, empty email, no-@ email, strips unknown keys), file errors (2 cases: nonexistent, invalid JSON)

    GREEN phase: Create `src/config/non-interactive-aws.ts`:
    - SetupAwsEnvsConfigSchema: z.object({ email: z.string().min(1, {message:'email is required'}) })
    - SetupAwsEnvsConfig type: z.infer of schema
    - loadSetupAwsEnvsConfig(configPath: string): SetupAwsEnvsConfig
      - resolve() path relative to cwd
      - readFileSync, JSON.parse, safeParse — same error handling as Phase 24's loadNonInteractiveConfig
      - After safeParse success, check result.data.email.includes('@') — if false, print format error and process.exit(1)
      - Return result.data
    - deriveEnvironmentEmails(rootEmail: string, environments: readonly string[]): Record<string, string>
      - Use lastIndexOf('@') to split local part and domain
      - Insert -{env} between local part and @domain for each environment
      - Return Record mapping env name to derived email

    IMPORTANT: Use `z.string().min(1)` NOT `z.string().email()` or `z.email()`. The strict email format check is a separate includes('@') check after safeParse. This matches the research recommendation and avoids Zod v3/v4 API confusion.
  </implementation>
</feature>

<verification>
```bash
npx jest --testPathPatterns non-interactive-aws
```
All tests pass. TypeScript compiles clean (`npx tsc --noEmit`).
</verification>

<success_criteria>
- deriveEnvironmentEmails correctly derives emails for dev/stage/prod from a root email
- loadSetupAwsEnvsConfig loads and validates a JSON config with only email required
- Missing email, empty email, and no-@ email all produce clear errors and exit 1
- Unknown keys stripped silently (z.object behavior)
- All tests pass, full test suite still passes
</success_criteria>

<output>
After completion, create `.planning/phases/25-non-interactive-setup-aws-envs/25-01-SUMMARY.md`
</output>
