---
phase: 15-formalize-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aws/iam.ts
  - src/commands/setup-aws-envs.ts
  - src/commands/initialize-github.ts
  - src/utils/project-context.ts
  - .planning/PROJECT.md
  - .planning/REQUIREMENTS.md
  - .planning/ROADMAP.md
autonomous: true

must_haves:
  truths:
    - "npm run build passes with zero errors"
    - "npm test passes all 118 unit tests"
    - "src/github/secrets.ts uses libsodium-wrappers via createRequire pattern (ENC-01, ENC-02)"
    - "tweetnacl is not in package.json or any source file (ENC-03)"
    - "templates/root/package.json includes @testing-library/dom as devDependency (TPL-01)"
    - "templates/apps/mobile/src/test-setup.ts imports @testing-library/react-native/extend-expect (TPL-02)"
    - "templates/apps/mobile/jest.config.ts uses jest-jasmine2 test runner (TPL-03)"
    - "setup-aws-envs creates IAM deployment users and saves user names to config"
    - "setup-aws-envs re-run after partial failure skips existing users and creates missing ones"
    - "initialize-github uses existing user from config when available"
    - "initialize-github falls back to full user creation when deploymentUsers not in config"
    - "PROJECT.md key decisions table includes libsodium, createRequire, jest-jasmine2, and extend-expect entries (DOC-01)"
  artifacts:
    - path: "src/github/secrets.ts"
      provides: "GitHub secrets encryption via libsodium crypto_box_seal"
      contains: "createRequire"
    - path: "src/aws/iam.ts"
      provides: "Idempotent IAM operations with existence checks"
      contains: "createOrAdoptDeploymentUser"
    - path: "src/commands/setup-aws-envs.ts"
      provides: "IAM user creation during env setup with summary table output"
      contains: "deploymentUsers"
    - path: "src/commands/initialize-github.ts"
      provides: "Access key creation for existing users with backward compat"
      contains: "existingUserName"
    - path: "src/utils/project-context.ts"
      provides: "Config interface with deploymentUsers field"
      contains: "deploymentUsers"
    - path: "templates/root/package.json"
      provides: "Root package with @testing-library/dom dependency"
      contains: "@testing-library/dom"
    - path: "templates/apps/mobile/src/test-setup.ts"
      provides: "Mobile test setup with extend-expect import"
      contains: "extend-expect"
    - path: "templates/apps/mobile/jest.config.ts"
      provides: "Mobile Jest config with jasmine2 runner"
      contains: "jest-jasmine2"
    - path: ".planning/PROJECT.md"
      provides: "Key decisions documentation for v1.5 changes"
      contains: "createRequire for CJS loading"
  key_links:
    - from: "src/github/secrets.ts"
      to: "libsodium-wrappers"
      via: "createRequire CJS import"
      pattern: "createRequire.*libsodium"
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/aws/iam.ts"
      via: "createOrAdoptDeploymentUser import"
      pattern: "createOrAdoptDeploymentUser|createDeploymentUser"
    - from: "src/commands/initialize-github.ts"
      to: "src/aws/iam.ts"
      via: "createAccessKey import for existing users"
      pattern: "createAccessKey"
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/utils/project-context.ts"
      via: "config.deploymentUsers written to disk"
      pattern: "deploymentUsers"
    - from: "src/commands/initialize-github.ts"
      to: "src/utils/project-context.ts"
      via: "config.deploymentUsers read from disk"
      pattern: "config\\.deploymentUsers"
---

<objective>
Verify all existing bug fixes (encryption, templates, documentation), harden CLI error handling for idempotent IAM operations, and commit the complete v1.5 changeset.

Purpose: The working tree already contains all core changes: libsodium encryption (ENC-01/02/03), template fixes (TPL-01/02/03), CLI architecture changes (CLI-01/02/03), and PROJECT.md updates (DOC-01). This plan first verifies those existing changes are correct, then hardens error handling per CONTEXT.md decisions, and finally commits everything.

Output: Verified encryption and template fixes, hardened setup-aws-envs and initialize-github commands, passing build and tests, clean git commit covering all requirements ENC-01 through DOC-01.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/15-formalize-bug-fixes/15-CONTEXT.md
@.planning/phases/15-formalize-bug-fixes/15-RESEARCH.md
@src/aws/iam.ts
@src/commands/setup-aws-envs.ts
@src/commands/initialize-github.ts
@src/utils/project-context.ts
@src/github/secrets.ts
@templates/root/package.json
@templates/apps/mobile/src/test-setup.ts
@templates/apps/mobile/jest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify encryption, template, and documentation fixes (ENC-01/02/03, TPL-01/02/03, DOC-01)</name>
  <files>
    src/github/secrets.ts
    templates/root/package.json
    templates/apps/mobile/src/test-setup.ts
    templates/apps/mobile/jest.config.ts
    .planning/PROJECT.md
    package.json
  </files>
  <action>
This task performs verification ONLY -- no file modifications. These fixes are already implemented in the working tree. Confirm each requirement is satisfied:

**ENC-01: libsodium crypto_box_seal**
1. Read `src/github/secrets.ts` and confirm it imports/uses `libsodium-wrappers` (not tweetnacl)
2. Confirm the encryption function calls `sodium.crypto_box_seal` (not tweetnacl's `box` or `secretbox`)
3. Grep `src/` for "tweetnacl" -- must return zero matches

**ENC-02: createRequire CJS loading**
4. In `src/github/secrets.ts`, confirm `createRequire(import.meta.url)` is used to load libsodium-wrappers
5. Confirm there's a comment explaining WHY createRequire is needed (ESM build has broken relative import)

**ENC-03: tweetnacl removed**
6. Read `package.json` (root) and confirm neither `tweetnacl` nor `tweetnacl-util` appear in dependencies or devDependencies
7. Grep the entire project for tweetnacl references in source files (src/ and templates/) -- must return zero matches (planning docs may still reference it historically, that's fine)

**TPL-01: @testing-library/dom**
8. Read `templates/root/package.json` and confirm `@testing-library/dom` appears in devDependencies

**TPL-02: extend-expect**
9. Read `templates/apps/mobile/src/test-setup.ts` and confirm it imports `@testing-library/react-native/extend-expect` (not `@testing-library/jest-native`)
10. Grep templates/ for "jest-native" -- should NOT appear (deprecated package replaced)

**TPL-03: jest-jasmine2**
11. Read `templates/apps/mobile/jest.config.ts` and confirm `testRunner: 'jest-jasmine2'` is present

**DOC-01: PROJECT.md key decisions**
12. Read `.planning/PROJECT.md` Key Decisions table and confirm these entries exist:
    - `libsodium-wrappers for encryption` (or similar)
    - `createRequire for CJS loading`
    - `jest-jasmine2 for mobile tests`
    - `@testing-library/react-native/extend-expect`

If ANY verification fails, fix the issue before proceeding. If all pass, log confirmation and move on.
  </action>
  <verify>
Grep src/ for "tweetnacl" -- zero matches.
Grep src/ for "createRequire" -- matches in src/github/secrets.ts.
Grep src/ for "crypto_box_seal" -- matches in src/github/secrets.ts.
Grep templates/ for "testing-library/dom" -- matches in templates/root/package.json.
Grep templates/ for "extend-expect" -- matches in templates/apps/mobile/src/test-setup.ts.
Grep templates/ for "jest-jasmine2" -- matches in templates/apps/mobile/jest.config.ts.
Grep .planning/PROJECT.md for "createRequire" -- matches in key decisions table.
  </verify>
  <done>
All 7 verification checks pass. ENC-01/02/03 confirmed (libsodium with createRequire, no tweetnacl). TPL-01/02/03 confirmed (testing-library/dom, extend-expect, jest-jasmine2). DOC-01 confirmed (all four key decisions documented in PROJECT.md).
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden IAM operations for idempotent re-runs</name>
  <files>
    src/aws/iam.ts
    src/commands/setup-aws-envs.ts
  </files>
  <action>
**In src/aws/iam.ts:**

1. Replace `createDeploymentUser` behavior when user already exists. Instead of throwing "Delete manually before retrying", implement detect-and-adopt:
   - If user exists AND has tag `ManagedBy: create-aws-starter-kit`, adopt it (return without error, log "Adopting existing deployment user: {name}")
   - If user exists WITHOUT the ManagedBy tag, throw descriptive error: "IAM user {name} exists but was not created by this tool. Delete it or use a different project name."
   - **Design note:** Only adopting ManagedBy-tagged users is intentional. This is safer than blindly adopting any existing IAM user, which could hijack unrelated users. CONTEXT.md says "detect and adopt" but the safer interpretation is to adopt only users we can verify were created by this tool.
   - Export a new function `createOrAdoptDeploymentUser` that wraps this behavior, or modify `createDeploymentUser` in-place. Keep the export name that setup-aws-envs uses.
   - To check tags: use `ListUserTagsCommand` from @aws-sdk/client-iam (import it). Check if any tag has Key="ManagedBy" and Value="create-aws-starter-kit".

2. Add `ListAccessKeysCommand` import. Add exported function `getAccessKeyCount(client, userName): Promise<number>` that returns the count of access keys for a user via `ListAccessKeysCommand`.

3. In `createAccessKey`: Before creating, check key count via `getAccessKeyCount`. If count >= 2, throw error: "IAM user {userName} already has 2 access keys (AWS maximum). Delete an existing key in AWS Console > IAM > Users > {userName} > Security credentials before retrying."

**In src/commands/setup-aws-envs.ts:**

4. In the IAM user creation loop, wrap each user creation to handle the adopt case gracefully:
   - If user is adopted (already exists), still save to config and show spinner succeed with "Using existing deployment user: {userName}"
   - If user is newly created, show spinner succeed with "Created deployment user: {userName}"

5. Replace the final success output with a summary table per CONTEXT.md:
   ```
   AWS environment setup complete!

   Summary:
     Environment  Account ID      Deployment User
     dev          123456789012    myapp-dev-deploy
     stage        234567890123    myapp-stage-deploy
     prod         345678901234    myapp-prod-deploy

   Deployment users created. Next: initialize-github to create access keys and push to GitHub.
     npx create-aws-project initialize-github dev
   ```

6. In the existing accounts warning at the top: also check for existing deploymentUsers in config and skip IAM user creation for environments that already have users (idempotent re-run after partial failure). Loop should only create users for environments where `config.deploymentUsers?.[env]` is falsy.

**Important:** Do NOT change the function signatures that initialize-github.ts depends on. The `createAccessKey` export must remain compatible. The `createDeploymentUser` export (or its replacement) must still work for the backward-compat path in initialize-github.

**Avoid:** Do not add interactive prompts for key rotation (CONTEXT.md says "error message first"). Just throw a clear error with instructions.
  </action>
  <verify>
Run `npm run build` -- must pass with zero errors.
Run `npm test` -- all 118 tests must pass.
Grep for "Delete manually before retrying" in src/ -- should NOT appear (replaced with adopt logic).
Grep for "ListUserTagsCommand" in src/aws/iam.ts -- should appear (tag checking).
Grep for "ListAccessKeysCommand" in src/aws/iam.ts -- should appear (key limit checking).
Grep for "Summary:" in src/commands/setup-aws-envs.ts -- should appear (summary table).
  </verify>
  <done>
setup-aws-envs handles re-runs idempotently: skips existing users (tagged), adopts them into config, only creates what's missing. Access key limit produces clear error message. Final output shows summary table with all environments.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update initialize-github output and commit verified v1.5 changeset</name>
  <files>
    src/commands/initialize-github.ts
    src/aws/iam.ts
    src/commands/setup-aws-envs.ts
    src/utils/project-context.ts
    .planning/PROJECT.md
    .planning/REQUIREMENTS.md
    .planning/ROADMAP.md
  </files>
  <action>
**In src/commands/initialize-github.ts:**

1. When using existing user from config (the `if (existingUserName)` branch), update spinner text to explicitly note it:
   - Change spinner text to: `Using existing deployment user: ${existingUserName}`
   - After creating access key, spinner succeed should say: `Created access key for ${userName}` (not show full ARN)

2. In the success summary section (after spinner.succeed), replace the IAM User ARN line:
   - Currently shows: `IAM User: arn:aws:iam::{accountId}:user/deployment/{userName}`
   - Change to show just the user name: `Deployment User: {userName}`
   - Keep the GitHub Environment line as-is

3. Add a brief inline note after the "Resources created" section when using existing user:
   ```
   Note: Deployment user was created by setup-aws-envs. Access key created for GitHub.
   ```
   Only show this note when `existingUserName` was truthy (new two-step flow).

**Final verification (run all before committing):**

4. Run `npm run build` -- must compile cleanly
5. Run `npm test` -- all 118 tests must pass
6. Verify no tweetnacl references: grep src/ for "tweetnacl" -- zero matches
7. Review git diff to ensure all changes are intentional and no debug code is present

**Commit the complete v1.5 changeset:**

8. Stage all modified files:
   ```
   git add src/aws/iam.ts src/commands/setup-aws-envs.ts src/commands/initialize-github.ts src/utils/project-context.ts .planning/PROJECT.md .planning/REQUIREMENTS.md .planning/ROADMAP.md
   ```
   Also stage any template files if they were modified in this session (they should already be committed, but check with `git status`).

9. Create a single descriptive commit:
   ```
   fix: harden CLI commands and formalize v1.5 bug fixes

   - setup-aws-envs: create IAM deployment users with idempotent re-run support
   - setup-aws-envs: detect and adopt existing tagged users, skip on re-run
   - setup-aws-envs: summary table output showing all environments
   - initialize-github: use existing deployment user from config when available
   - initialize-github: fall back to full user creation for backward compat
   - initialize-github: show user name instead of full ARN in output
   - iam.ts: access key limit detection (max 2 per user)
   - project-context: add deploymentUsers field to config interface
   - Verified: libsodium encryption, template fixes, PROJECT.md decisions
   ```

10. After commit, run `npm run build && npm test` one final time to confirm the committed state is clean.

11. Run `git log --oneline -5` to confirm the commit is clean and properly formatted.

**Do NOT push** -- user decides when to push.
  </action>
  <verify>
Run `npm run build` -- passes.
Run `npm test` -- 118 tests pass.
Grep for "Deployment User:" in src/commands/initialize-github.ts -- should appear.
Grep for "created by setup-aws-envs" in src/commands/initialize-github.ts -- should appear (inline note).
Run `git status` -- working tree should be clean (no unstaged changes).
Run `git log --oneline -1` -- shows the commit message.
  </verify>
  <done>
initialize-github shows user name (not ARN) in success output, explicitly notes when using existing deployment user. All v1.5 changes committed in a single clean commit. Build and tests pass. Working tree is clean. All requirements ENC-01 through DOC-01 verified and committed.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the full phase success criteria from ROADMAP.md:

1. `npm run build` passes with libsodium-wrappers (no tweetnacl references remain)
2. `npm test` passes all 118 unit tests
3. `git log --oneline -1` shows clean commit with v1.5 bug fixes
4. `git status` shows clean working tree
5. Grep src/ for "tweetnacl" returns zero matches
6. Grep src/ for "createRequire" confirms libsodium loading pattern (ENC-02)
7. Grep templates/ for "@testing-library/dom" confirms TPL-01
8. Grep templates/ for "extend-expect" confirms TPL-02
9. Grep templates/ for "jest-jasmine2" confirms TPL-03
10. Grep .planning/PROJECT.md for "createRequire" confirms DOC-01
11. Grep src/commands/setup-aws-envs.ts for "deploymentUsers" confirms CLI-01
12. Grep src/commands/initialize-github.ts for "existingUserName" confirms CLI-02/CLI-03

Note: E2E tests (`npm run test:e2e`) are not run as part of this plan because they require actual project generation with npm install (several minutes per config). The unit tests and build verification confirm code correctness. E2E can be run separately by the user.
</verification>

<success_criteria>
- Build passes with zero errors
- All 118 unit tests pass
- ENC-01/02/03 verified: libsodium with createRequire, crypto_box_seal, no tweetnacl
- TPL-01/02/03 verified: testing-library/dom, extend-expect, jest-jasmine2
- DOC-01 verified: PROJECT.md key decisions include all four v1.5 entries
- CLI-01/02/03: setup-aws-envs creates IAM users idempotently, initialize-github reads from config
- setup-aws-envs outputs summary table with account IDs and user names
- initialize-github shows user name (not ARN) and notes two-step flow
- Access key limit (max 2) detected with clear error message
- All changes committed in single clean commit
- Working tree is clean after commit
</success_criteria>

<output>
After completion, create `.planning/phases/15-formalize-bug-fixes/15-01-SUMMARY.md`
</output>
