---
phase: 15-formalize-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aws/iam.ts
  - src/commands/setup-aws-envs.ts
  - src/commands/initialize-github.ts
  - src/utils/project-context.ts
  - .planning/REQUIREMENTS.md
  - .planning/ROADMAP.md
autonomous: true

must_haves:
  truths:
    - "npm run build passes with zero errors"
    - "npm test passes all 118 unit tests"
    - "setup-aws-envs creates IAM deployment users and saves user names to config"
    - "setup-aws-envs re-run after partial failure skips existing users and creates missing ones"
    - "initialize-github uses existing user from config when available"
    - "initialize-github falls back to full user creation when deploymentUsers not in config"
    - "No tweetnacl references remain in source code or package.json"
  artifacts:
    - path: "src/aws/iam.ts"
      provides: "Idempotent IAM operations with existence checks"
      contains: "createOrAdoptDeploymentUser"
    - path: "src/commands/setup-aws-envs.ts"
      provides: "IAM user creation during env setup with summary table output"
      contains: "deploymentUsers"
    - path: "src/commands/initialize-github.ts"
      provides: "Access key creation for existing users with backward compat"
      contains: "existingUserName"
    - path: "src/utils/project-context.ts"
      provides: "Config interface with deploymentUsers field"
      contains: "deploymentUsers"
  key_links:
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/aws/iam.ts"
      via: "createOrAdoptDeploymentUser import"
      pattern: "createOrAdoptDeploymentUser|createDeploymentUser"
    - from: "src/commands/initialize-github.ts"
      to: "src/aws/iam.ts"
      via: "createAccessKey import for existing users"
      pattern: "createAccessKey"
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/utils/project-context.ts"
      via: "config.deploymentUsers written to disk"
      pattern: "deploymentUsers"
    - from: "src/commands/initialize-github.ts"
      to: "src/utils/project-context.ts"
      via: "config.deploymentUsers read from disk"
      pattern: "config\\.deploymentUsers"
---

<objective>
Harden error handling in CLI commands for idempotent IAM operations, verify all bug fixes, and commit the complete v1.5 changeset.

Purpose: The working tree already contains the core CLI architecture changes (IAM user creation moved to setup-aws-envs, initialize-github reads existing users). This plan hardens error handling per CONTEXT.md decisions (idempotent re-runs, detect-and-adopt existing users, access key limit handling, summary table output) and commits the verified changes.

Output: Hardened setup-aws-envs and initialize-github commands, passing build and tests, clean git commit covering requirements ENC-01 through DOC-01.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-formalize-bug-fixes/15-CONTEXT.md
@.planning/phases/15-formalize-bug-fixes/15-RESEARCH.md
@src/aws/iam.ts
@src/commands/setup-aws-envs.ts
@src/commands/initialize-github.ts
@src/utils/project-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden IAM operations for idempotent re-runs</name>
  <files>
    src/aws/iam.ts
    src/commands/setup-aws-envs.ts
  </files>
  <action>
**In src/aws/iam.ts:**

1. Replace `createDeploymentUser` behavior when user already exists. Instead of throwing "Delete manually before retrying", implement detect-and-adopt:
   - If user exists AND has tag `ManagedBy: create-aws-starter-kit`, adopt it (return without error, log "Adopting existing deployment user: {name}")
   - If user exists WITHOUT the ManagedBy tag, throw descriptive error: "IAM user {name} exists but was not created by this tool. Delete it or use a different project name."
   - Export a new function `createOrAdoptDeploymentUser` that wraps this behavior, or modify `createDeploymentUser` in-place. Keep the export name that setup-aws-envs uses.
   - To check tags: use `ListUserTagsCommand` from @aws-sdk/client-iam (import it). Check if any tag has Key="ManagedBy" and Value="create-aws-starter-kit".

2. Add `ListAccessKeysCommand` import. Add exported function `getAccessKeyCount(client, userName): Promise<number>` that returns the count of access keys for a user via `ListAccessKeysCommand`.

3. In `createAccessKey`: Before creating, check key count via `getAccessKeyCount`. If count >= 2, throw error: "IAM user {userName} already has 2 access keys (AWS maximum). Delete an existing key in AWS Console > IAM > Users > {userName} > Security credentials before retrying."

**In src/commands/setup-aws-envs.ts:**

4. In the IAM user creation loop, wrap each user creation to handle the adopt case gracefully:
   - If user is adopted (already exists), still save to config and show spinner succeed with "Using existing deployment user: {userName}"
   - If user is newly created, show spinner succeed with "Created deployment user: {userName}"

5. Replace the final success output with a summary table per CONTEXT.md:
   ```
   AWS environment setup complete!

   Summary:
     Environment  Account ID      Deployment User
     dev          123456789012    myapp-dev-deploy
     stage        234567890123    myapp-stage-deploy
     prod         345678901234    myapp-prod-deploy

   Deployment users created. Next: initialize-github to create access keys and push to GitHub.
     npx create-aws-project initialize-github dev
   ```

6. In the existing accounts warning at the top: also check for existing deploymentUsers in config and skip IAM user creation for environments that already have users (idempotent re-run after partial failure). Loop should only create users for environments where `config.deploymentUsers?.[env]` is falsy.

**Important:** Do NOT change the function signatures that initialize-github.ts depends on. The `createAccessKey` export must remain compatible. The `createDeploymentUser` export (or its replacement) must still work for the backward-compat path in initialize-github.

**Avoid:** Do not add interactive prompts for key rotation (CONTEXT.md says "error message first"). Just throw a clear error with instructions.
  </action>
  <verify>
Run `npm run build` -- must pass with zero errors.
Run `npm test` -- all 118 tests must pass.
Grep for "Delete manually before retrying" in src/ -- should NOT appear (replaced with adopt logic).
Grep for "ListUserTagsCommand" in src/aws/iam.ts -- should appear (tag checking).
Grep for "ListAccessKeysCommand" in src/aws/iam.ts -- should appear (key limit checking).
Grep for "Summary:" in src/commands/setup-aws-envs.ts -- should appear (summary table).
  </verify>
  <done>
setup-aws-envs handles re-runs idempotently: skips existing users (tagged), adopts them into config, only creates what's missing. Access key limit produces clear error message. Final output shows summary table with all environments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update initialize-github output and verify full changeset</name>
  <files>
    src/commands/initialize-github.ts
  </files>
  <action>
**In src/commands/initialize-github.ts:**

1. When using existing user from config (the `if (existingUserName)` branch), update spinner text to explicitly note it:
   - Change spinner text to: `Using existing deployment user: ${existingUserName}`
   - After creating access key, spinner succeed should say: `Created access key for ${userName}` (not show full ARN)

2. In the success summary section (after spinner.succeed), replace the IAM User ARN line:
   - Currently shows: `IAM User: arn:aws:iam::{accountId}:user/deployment/{userName}`
   - Change to show just the user name: `Deployment User: {userName}`
   - Keep the GitHub Environment line as-is

3. Add a brief inline note after the "Resources created" section when using existing user:
   ```
   Note: Deployment user was created by setup-aws-envs. Access key created for GitHub.
   ```
   Only show this note when `existingUserName` was truthy (new two-step flow).

**Verification steps (run all):**

4. Run `npm run build` -- must compile cleanly
5. Run `npm test` -- all 118 tests must pass
6. Run `npm run lint` (if it exists) or `npx eslint src/` -- check for lint issues
7. Verify no tweetnacl references: grep the entire src/ directory for "tweetnacl" -- zero matches expected
8. Review the git diff to ensure all changes are intentional and no debug code is present

**Do NOT commit yet** -- Task 3 handles the commit.
  </action>
  <verify>
Run `npm run build` -- passes.
Run `npm test` -- 118 tests pass.
Grep for "Deployment User:" in src/commands/initialize-github.ts -- should appear.
Grep for "created by setup-aws-envs" in src/commands/initialize-github.ts -- should appear (inline note).
Grep for "arn:aws:iam" in src/commands/initialize-github.ts success output -- should NOT appear in the user display line (replaced with just user name).
  </verify>
  <done>
initialize-github shows user name (not ARN) in success output, explicitly notes when using existing deployment user from setup-aws-envs, and includes inline note explaining the two-step flow.
  </done>
</task>

<task type="auto">
  <name>Task 3: Commit verified v1.5 bug fixes</name>
  <files>
    src/aws/iam.ts
    src/commands/setup-aws-envs.ts
    src/commands/initialize-github.ts
    src/utils/project-context.ts
    .planning/REQUIREMENTS.md
    .planning/ROADMAP.md
  </files>
  <action>
1. Stage all modified files for commit:
   ```
   git add src/aws/iam.ts src/commands/setup-aws-envs.ts src/commands/initialize-github.ts src/utils/project-context.ts .planning/REQUIREMENTS.md .planning/ROADMAP.md
   ```

2. Create a single descriptive commit:
   ```
   fix: harden CLI commands and formalize v1.5 bug fixes

   - setup-aws-envs: create IAM deployment users with idempotent re-run support
   - setup-aws-envs: detect and adopt existing tagged users, skip on re-run
   - setup-aws-envs: summary table output showing all environments
   - initialize-github: use existing deployment user from config when available
   - initialize-github: fall back to full user creation for backward compat
   - initialize-github: show user name instead of full ARN in output
   - iam.ts: access key limit detection (max 2 per user)
   - project-context: add deploymentUsers field to config interface
   ```

3. After commit, run `npm run build && npm test` one final time to confirm the committed state is clean.

4. Run `git log --oneline -5` to confirm the commit is clean and properly formatted.

**Do NOT push** -- user decides when to push.
  </action>
  <verify>
Run `git status` -- working tree should be clean (no unstaged changes).
Run `npm run build` -- passes from committed state.
Run `npm test` -- 118 tests pass from committed state.
Run `git log --oneline -1` -- shows the commit message.
  </verify>
  <done>
All v1.5 changes committed in a single clean commit. Build and tests pass. Working tree is clean. Requirements ENC-01 through DOC-01 covered by combination of this commit and prior commits.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the full phase success criteria from ROADMAP.md:

1. `npm run build` passes with libsodium-wrappers (no tweetnacl references remain)
2. `npm test` passes all 118 unit tests
3. `git log --oneline -1` shows clean commit with v1.5 bug fixes
4. `git status` shows clean working tree
5. Grep src/ for "tweetnacl" returns zero matches
6. Grep src/commands/setup-aws-envs.ts for "deploymentUsers" confirms IAM user creation
7. Grep src/commands/initialize-github.ts for "existingUserName" confirms backward compat path

Note: E2E tests (`npm run test:e2e`) are not run as part of this plan because they require actual project generation with npm install (several minutes per config). The unit tests and build verification confirm code correctness. E2E can be run separately by the user.
</verification>

<success_criteria>
- Build passes with zero errors
- All 118 unit tests pass
- setup-aws-envs creates IAM users idempotently (skip existing, adopt tagged, create missing)
- setup-aws-envs outputs summary table with account IDs and user names
- initialize-github uses existing user from config, falls back to full creation
- initialize-github shows user name (not ARN) and notes two-step flow
- Access key limit (max 2) detected with clear error message
- All changes committed in single clean commit
- Working tree is clean after commit
</success_criteria>

<output>
After completion, create `.planning/phases/15-formalize-bug-fixes/15-01-SUMMARY.md`
</output>
