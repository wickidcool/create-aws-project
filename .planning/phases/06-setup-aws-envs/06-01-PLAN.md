---
phase: 06-setup-aws-envs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/commands/setup-aws-envs.ts
autonomous: true

must_haves:
  truths:
    - "User can run setup-aws-envs from project directory and see email prompts"
    - "Command creates AWS Organization if none exists"
    - "Command creates three environment accounts (dev, stage, prod)"
    - "Account IDs are saved to config file after each successful creation"
    - "User sees spinner progress during AWS operations"
    - "Clear error messages shown for AWS permission issues"
  artifacts:
    - path: "src/commands/setup-aws-envs.ts"
      provides: "Full setup-aws-envs command implementation"
      min_lines: 150
      exports: ["runSetupAwsEnvs"]
  key_links:
    - from: "src/commands/setup-aws-envs.ts"
      to: "src/aws/organizations.ts"
      via: "imports createOrganizationsClient, checkExistingOrganization, createOrganization, createAccount, waitForAccountCreation"
      pattern: "from.*organizations\\.js"
    - from: "src/commands/setup-aws-envs.ts"
      to: ".aws-starter-config.json"
      via: "reads config via requireProjectContext, writes updated accounts"
      pattern: "writeFileSync.*configPath"
---

<objective>
Implement the setup-aws-envs command that creates AWS Organizations and environment accounts

Purpose: Enable users to set up multi-account AWS infrastructure from their generated project. This command bridges the gap between project generation (Phase 5) and GitHub deployment setup (Phase 7).

Output: Working setup-aws-envs command that:
1. Collects email addresses for dev, stage, prod accounts
2. Creates AWS Organization (or uses existing)
3. Creates three environment accounts with progress indication
4. Saves account IDs to project config file
5. Handles errors gracefully with actionable messages
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-setup-aws-envs/06-RESEARCH.md

# Existing infrastructure
@src/commands/setup-aws-envs.ts
@src/aws/organizations.ts
@src/utils/project-context.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ora dependency and implement email collection</name>
  <files>
    package.json
    src/commands/setup-aws-envs.ts
  </files>
  <action>
1. Add ora dependency:
   ```bash
   npm install ora
   ```

2. In src/commands/setup-aws-envs.ts, add imports at top:
   - ora from 'ora'
   - prompts from 'prompts'
   - { readFileSync, writeFileSync } from 'node:fs'
   - Existing AWS functions from '../aws/organizations.js'

3. Add EnvironmentEmails interface:
   ```typescript
   interface EnvironmentEmails {
     dev: string;
     stage: string;
     prod: string;
   }
   ```

4. Add ENVIRONMENTS constant:
   ```typescript
   const ENVIRONMENTS = ['dev', 'stage', 'prod'] as const;
   ```

5. Add email validation functions:
   - validateEmail(value: string): boolean | string - checks non-empty and valid format
   - validateUniqueEmail(value: string, existing: string[]): boolean | string - validates format AND uniqueness

6. Add collectEmails function that:
   - Displays header explaining unique email requirement
   - Shows tip about email aliases (yourname+dev@company.com)
   - Uses prompts() with three sequential text inputs for dev, stage, prod
   - Each prompt uses appropriate validation (first uses validateEmail, others use validateUniqueEmail)
   - Has onCancel handler that exits with code 1
   - Validates all three emails were provided before returning
   - Returns EnvironmentEmails object

Pattern from research doc (06-RESEARCH.md) - use the collectEmails and validation patterns shown there.
  </action>
  <verify>
1. `npm ls ora` shows ora installed
2. `npm run build` succeeds without errors
3. Grep for 'validateEmail' in setup-aws-envs.ts shows function exists
4. Grep for 'collectEmails' in setup-aws-envs.ts shows function exists
  </verify>
  <done>
ora dependency installed, email validation functions and collectEmails() implemented in setup-aws-envs.ts, build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement full command orchestration with progress and error handling</name>
  <files>
    src/commands/setup-aws-envs.ts
  </files>
  <action>
Replace the stub runSetupAwsEnvs implementation with full command:

1. Add updateConfigAccounts helper function:
   - Takes configPath (string) and accounts (Record<string, string>)
   - Reads existing config with readFileSync
   - Parses JSON, merges new accounts into config.accounts
   - Writes back with JSON.stringify(config, null, 2) + '\n'

2. Add handleAwsError function (from research patterns):
   - Takes error: unknown, returns never (always exits)
   - Switch on error.name for specific AWS exceptions:
     - AccessDeniedException: Show required permissions list
     - AWSOrganizationsNotInUseException: Unexpected state message
     - ConstraintViolationException: Account limit reached
     - FinalizingOrganizationException: Wait and retry message
     - TooManyRequestsException: Rate limit message
     - default: Show error.message and error.name
   - Always exits with process.exit(1)

3. Implement runSetupAwsEnvs:
   a. Get project context (already has requireProjectContext() call)

   b. Check if already configured:
      - If config.accounts has keys, warn user and show existing
      - Do NOT auto-abort - proceed to email collection (allows retry after partial failure)

   c. Collect emails:
      - Call collectEmails(config.projectName)
      - This is BEFORE any AWS calls (pitfall from research)

   d. Start AWS operations with ora spinner:
      - Create spinner: ora('Starting AWS Organizations setup...').start()
      - Wrap entire AWS operation block in try/catch

   e. Create Organizations client:
      - IMPORTANT: Always use 'us-east-1' regardless of config.awsRegion (Organizations API is region-locked)

   f. Check/create organization:
      - spinner.text = 'Checking for existing AWS Organization...'
      - Call checkExistingOrganization(client)
      - If null, create: spinner.text = 'Creating AWS Organization...', call createOrganization(client)
      - spinner.succeed() with org ID

   g. Create accounts sequentially:
      - Initialize accounts: Record<string, string> = {}
      - For each env in ENVIRONMENTS:
        - spinner.start(`Creating ${env} account (this may take several minutes)...`)
        - accountName = `${config.projectName}-${env}`
        - Call createAccount(client, emails[env], accountName)
        - spinner.text = `Waiting for ${env} account creation...`
        - Call waitForAccountCreation(client, requestId)
        - Add to accounts object
        - IMMEDIATELY call updateConfigAccounts(context.configPath, accounts) - save after EACH account
        - spinner.succeed(`Created ${env} account: ${accountId}`)

   h. Show success:
      - console.log success message
      - Show all created account IDs
      - Show next step: npx create-aws-project initialize-github dev

   i. Catch block:
      - spinner.fail('AWS setup failed')
      - Call handleAwsError(error)

Use patterns from 06-RESEARCH.md for all implementations.
  </action>
  <verify>
1. `npm run build` succeeds
2. Grep for 'updateConfigAccounts' shows function exists
3. Grep for 'handleAwsError' shows function exists
4. Grep for 'us-east-1' confirms hardcoded region for Organizations API
5. Grep for 'updateConfigAccounts.*configPath' confirms config saved after each account
6. Grep for 'initialize-github' confirms next step guidance shown
  </verify>
  <done>
Full setup-aws-envs command implemented with:
- Organization check/creation with spinner
- Sequential account creation with progress
- Config file updated after each successful account
- Comprehensive error handling with actionable messages
- Build passes
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   npm run build
   ```

2. Static verification (grep checks):
   - ora imported and used for spinners
   - All AWS functions imported from organizations.js
   - Email validation functions present
   - Error handler covers key AWS exceptions
   - Config update happens after each account creation

3. Code structure verification:
   - runSetupAwsEnvs exports correctly
   - File should be 150-250 lines
   - No console.log during spinner operations (spinner handles output)

Note: Full functional testing requires AWS credentials and is out of scope for automated verification. Manual testing by user after deployment.
</verification>

<success_criteria>
1. `npm run build` passes with no errors
2. `npm ls ora` shows ora@^9.0.0 installed
3. src/commands/setup-aws-envs.ts contains:
   - Email collection with validation
   - Organization creation logic
   - Account creation loop with config saves
   - Error handling for AWS exceptions
   - Spinner progress indication
4. Command follows research patterns for:
   - Collecting all input before AWS calls
   - Saving config after each account (partial success handling)
   - Using us-east-1 for Organizations API
</success_criteria>

<output>
After completion, create `.planning/phases/06-setup-aws-envs/06-01-SUMMARY.md`
</output>
