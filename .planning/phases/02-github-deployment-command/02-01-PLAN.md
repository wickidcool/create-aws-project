---
phase: 02-github-deployment-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, package-lock.json, src/aws/iam.ts]
autonomous: true
---

<objective>
Create IAM service module for deployment user management with least-privilege policies.

Purpose: Provide AWS IAM SDK functions to create deployment users with minimal permissions for CDK deployment per environment.
Output: `src/aws/iam.ts` with functions for creating IAM users, attaching policies, and generating access keys.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context - org SDK patterns
@.planning/phases/01-aws-organizations-foundation/01-02-SUMMARY.md

# Existing AWS SDK patterns
@src/aws/organizations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AWS SDK IAM dependency</name>
  <files>package.json, package-lock.json</files>
  <action>
  Install @aws-sdk/client-iam as production dependency using npm install.

  This follows the same pattern as Phase 1 where we added @aws-sdk/client-organizations.
  </action>
  <verify>npm ls @aws-sdk/client-iam shows package installed</verify>
  <done>@aws-sdk/client-iam appears in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create IAM service module</name>
  <files>src/aws/iam.ts</files>
  <action>
  Create IAM service module following the Organizations SDK pattern from src/aws/organizations.ts.

  **Functions to implement:**

  1. `createIAMClient(region: string): IAMClient` - Factory for IAMClient

  2. `createDeploymentUser(client: IAMClient, userName: string): Promise<void>`
     - Creates IAM user with path /deployment/
     - User name format: `{project}-{environment}-deploy` (e.g., `myapp-dev-deploy`)

  3. `createCDKDeploymentPolicy(client: IAMClient, policyName: string, accountId: string): Promise<string>`
     - Creates a customer managed policy with minimal CDK deployment permissions
     - Returns the policy ARN
     - Policy should include:
       - cloudformation:* (for CDK stacks)
       - s3:* on cdk bootstrap bucket (arn:aws:s3:::cdk-*-{accountId}-*)
       - iam:PassRole for CDK execution role
       - sts:AssumeRole for CDK roles
       - ssm:GetParameter for CDK context
       - lambda:*, apigateway:*, dynamodb:*, cloudfront:*, cognito-idp:* (for the actual resources)
     - Policy name format: `{project}-{environment}-cdk-deploy`

  4. `attachPolicyToUser(client: IAMClient, userName: string, policyArn: string): Promise<void>`
     - Attaches the deployment policy to the user

  5. `createAccessKey(client: IAMClient, userName: string): Promise<{accessKeyId: string, secretAccessKey: string}>`
     - Creates and returns access key credentials for the user
     - IMPORTANT: The secret is only available at creation time

  6. `createDeploymentUserWithCredentials(client: IAMClient, projectName: string, environment: string, accountId: string): Promise<{userName: string, accessKeyId: string, secretAccessKey: string}>`
     - High-level function that orchestrates: create user → create policy → attach policy → create access key
     - Returns all credentials needed for GitHub secrets

  **Important notes:**
  - Use picocolors for progress output (consistent with organizations.ts)
  - Handle existing user/policy gracefully (check if exists first, reuse or error)
  - Export all functions for testing and composition
  - Use TypeScript types from @aws-sdk/client-iam
  </action>
  <verify>
  TypeScript compiles without errors: npm run build
  </verify>
  <done>
  - src/aws/iam.ts exists with all 6 functions exported
  - Functions use proper TypeScript types
  - npm run build succeeds
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] npm ls @aws-sdk/client-iam shows package installed
- [ ] src/aws/iam.ts exports all 6 functions
- [ ] TypeScript types are properly used (no `any` types)
</verification>

<success_criteria>

- @aws-sdk/client-iam installed as production dependency
- IAM service module created with deployment user management functions
- Follows existing AWS SDK patterns from organizations.ts
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-github-deployment-command/02-01-SUMMARY.md`
</output>
