---
phase: 02-github-deployment-command
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified: [src/commands/setup-github.ts, src/cli.ts, src/prompts/github-setup.ts]
autonomous: false
---

<objective>
Create setup-github CLI command that orchestrates IAM user creation and GitHub secrets configuration.

Purpose: Provide a standalone CLI command that creates deployment users and configures GitHub repository secrets for each environment.
Output: Working `npx create-aws-starter-kit setup-github` command that sets up deployment credentials.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan outputs
@.planning/phases/02-github-deployment-command/02-01-SUMMARY.md
@.planning/phases/02-github-deployment-command/02-02-SUMMARY.md

# Existing CLI patterns
@src/cli.ts
@src/wizard.ts
@src/prompts/org-structure.ts

# Services to use
@src/aws/iam.ts
@src/github/secrets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub setup prompts</name>
  <files>src/prompts/github-setup.ts</files>
  <action>
  Create prompts module for the setup-github command. Follow patterns from src/prompts/org-structure.ts.

  **Prompts to implement:**

  1. `projectNamePrompt` - Text input for project name (used as prefix for IAM users)
     - Validate: kebab-case, 1-20 chars
     - Example: "my-app" → creates "my-app-dev-deploy" user

  2. `awsRegionPrompt` - Select from common regions
     - Reuse pattern from existing prompts
     - Default to us-east-1

  3. `environmentsPrompt` - Multiselect for environments to configure
     - Choices: dev, stage, prod
     - Default: all selected

  4. `accountIdPrompts` - Text input for each selected environment's AWS account ID
     - Validate: 12-digit number
     - Message: "AWS Account ID for {environment}"
     - These are the accounts where IAM users will be created

  5. `githubRepoPrompt` - Text input for GitHub repository
     - Accept formats: owner/repo, https://github.com/owner/repo
     - Validate: can parse to owner/repo

  6. `githubTokenPrompt` - Password input for GitHub PAT
     - Message: "GitHub Personal Access Token (requires 'repo' scope)"
     - No validation (API will validate)

  Export a `runGitHubSetupWizard()` function that runs all prompts and returns:
  ```typescript
  interface GitHubSetupConfig {
    projectName: string;
    awsRegion: string;
    environments: Array<{environment: string; accountId: string}>;
    github: {owner: string; repo: string; token: string};
  }
  ```

  Handle user cancellation (Ctrl+C) gracefully by returning null.
  </action>
  <verify>npm run build compiles without errors</verify>
  <done>src/prompts/github-setup.ts exports runGitHubSetupWizard function</done>
</task>

<task type="auto">
  <name>Task 2: Create setup-github command module</name>
  <files>src/commands/setup-github.ts</files>
  <action>
  Create command module that orchestrates the setup-github flow.

  **Implementation:**

  ```typescript
  export async function runSetupGitHub(): Promise<void> {
    // 1. Print banner
    // 2. Run GitHub setup wizard (prompts)
    // 3. For each environment:
    //    a. Create IAM client for that account (will need credentials/role assumption)
    //    b. Create deployment user with createDeploymentUserWithCredentials()
    //    c. Set GitHub secrets with setEnvironmentCredentials()
    // 4. Print success summary with secrets created
  }
  ```

  **Important considerations:**

  - **AWS credential handling**: The user running this command needs credentials that can assume roles in each target account, OR they need to run the command multiple times with different AWS profiles. For simplicity, assume the user has credentials configured for each account and prompt them to set AWS_PROFILE before running.

  - Actually, simpler approach: Ask user which AWS profile to use for each environment via prompts. Then use AWS SDK's fromIni() credential provider with the specified profile.

  Add to github-setup.ts prompts:
  7. `awsProfilePrompts` - Text input for AWS profile name for each environment
     - Message: "AWS profile for {environment} account"
     - Default: "default"

  Update GitHubSetupConfig:
  ```typescript
  environments: Array<{environment: string; accountId: string; awsProfile: string}>;
  ```

  **Error handling:**
  - AWS credential errors → helpful message about configuring profiles
  - GitHub API errors → check token scopes
  - IAM errors → check permissions

  **Progress output:**
  - Use picocolors for colored output
  - Show progress for each environment: "Setting up dev environment..."
  - Show checkmarks for completed steps
  </action>
  <verify>npm run build compiles without errors</verify>
  <done>src/commands/setup-github.ts exports runSetupGitHub function</done>
</task>

<task type="auto">
  <name>Task 3: Add setup-github command to CLI</name>
  <files>src/cli.ts</files>
  <action>
  Modify cli.ts to handle the setup-github subcommand.

  **Changes:**

  1. Update argument parsing to detect `setup-github` as first non-flag argument:
     ```typescript
     const command = args.find(arg => !arg.startsWith('-'));
     ```

  2. Add command routing:
     ```typescript
     if (command === 'setup-github') {
       await runSetupGitHub();
       process.exit(0);
     }
     ```

  3. Update help message to include the new command:
     ```
     Commands:
       setup-github    Configure GitHub Actions deployment credentials

     Usage:
       create-aws-starter-kit [project-name]    Create a new project
       create-aws-starter-kit setup-github      Configure GitHub deployment
     ```

  4. Import runSetupGitHub from ./commands/setup-github.js

  The default behavior (no command) remains the project creation wizard.
  </action>
  <verify>npm run build compiles and CLI shows setup-github in help</verify>
  <done>
  - CLI help shows setup-github command
  - Running with setup-github argument routes to the new command
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete setup-github command that:
  1. Prompts for project name, environments, AWS profiles, and GitHub repo
  2. Creates IAM deployment users with least-privilege policies
  3. Configures GitHub repository secrets for each environment
  </what-built>
  <how-to-verify>
    1. Build the project: npm run build
    2. Check help: node dist/index.js --help (should show setup-github command)
    3. Run setup-github: node dist/index.js setup-github
    4. Walk through the wizard prompts
    5. Verify in AWS Console: IAM users created with correct policies
    6. Verify in GitHub: Repository > Settings > Secrets shows AWS credentials
  </how-to-verify>
  <resume-signal>Type "approved" if credentials are configured correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] CLI help shows setup-github command
- [ ] Wizard prompts work correctly
- [ ] IAM users created in AWS (verified by user)
- [ ] GitHub secrets configured (verified by user)
</verification>

<success_criteria>

- setup-github command accessible via CLI
- Wizard collects all required configuration
- IAM deployment users created with appropriate policies
- GitHub repository secrets configured for each environment
- User can verify both AWS and GitHub configurations
</success_criteria>

<output>
After completion, create `.planning/phases/02-github-deployment-command/02-03-SUMMARY.md`
</output>
