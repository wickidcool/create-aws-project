---
phase: 02-github-deployment-command
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [package.json, package-lock.json, src/github/secrets.ts]
autonomous: true
---

<objective>
Create GitHub service module for repository secrets management.

Purpose: Provide GitHub API functions to configure repository secrets for AWS deployment credentials.
Output: `src/github/secrets.ts` with functions for setting repository secrets using the GitHub REST API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns
@src/aws/organizations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Octokit dependency</name>
  <files>package.json, package-lock.json</files>
  <action>
  Install @octokit/rest as production dependency using npm install.

  Octokit is GitHub's official SDK for the REST API. Use @octokit/rest (not @octokit/core) for cleaner API access to repository secrets endpoints.
  </action>
  <verify>npm ls @octokit/rest shows package installed</verify>
  <done>@octokit/rest appears in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub secrets service module</name>
  <files>src/github/secrets.ts</files>
  <action>
  Create GitHub secrets service module for managing repository secrets.

  **Functions to implement:**

  1. `createGitHubClient(token: string): Octokit`
     - Factory for Octokit client with provided PAT
     - Token requires `repo` scope for secrets access

  2. `getRepositoryPublicKey(client: Octokit, owner: string, repo: string): Promise<{keyId: string, key: string}>`
     - Fetches the repository's public key for encrypting secrets
     - GitHub encrypts secrets using libsodium sealed boxes
     - GET /repos/{owner}/{repo}/actions/secrets/public-key

  3. `encryptSecret(publicKey: string, secretValue: string): Promise<string>`
     - Encrypts the secret value using the repository's public key
     - Use tweetnacl or libsodium-wrappers for encryption
     - Returns base64-encoded encrypted value
     - Install tweetnacl and tweetnacl-util as dependencies (lighter than libsodium)

  4. `setRepositorySecret(client: Octokit, owner: string, repo: string, secretName: string, secretValue: string): Promise<void>`
     - Sets (creates or updates) a repository secret
     - Steps: get public key → encrypt value → PUT secret
     - PUT /repos/{owner}/{repo}/actions/secrets/{secret_name}
     - Secret names: AWS_ACCESS_KEY_ID_{ENV}, AWS_SECRET_ACCESS_KEY_{ENV} (e.g., AWS_ACCESS_KEY_ID_DEV)

  5. `setEnvironmentCredentials(client: Octokit, owner: string, repo: string, environment: string, accessKeyId: string, secretAccessKey: string): Promise<void>`
     - High-level function that sets both AWS credentials for an environment
     - Creates secrets: AWS_ACCESS_KEY_ID_{ENVIRONMENT}, AWS_SECRET_ACCESS_KEY_{ENVIRONMENT}
     - Environment is uppercased (dev → DEV)

  6. `parseGitHubUrl(url: string): {owner: string, repo: string}`
     - Parse GitHub repository URL to extract owner and repo
     - Support formats: https://github.com/owner/repo, git@github.com:owner/repo.git, owner/repo

  **Important notes:**
  - Use picocolors for progress output (consistent with other services)
  - Handle API errors gracefully with clear error messages
  - Export all functions for testing and composition
  - Token validation: if API returns 401, provide helpful message about required scopes
  </action>
  <verify>
  TypeScript compiles without errors: npm run build
  </verify>
  <done>
  - src/github/secrets.ts exists with all 6 functions exported
  - tweetnacl and tweetnacl-util installed for encryption
  - npm run build succeeds
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] npm ls @octokit/rest shows package installed
- [ ] npm ls tweetnacl shows package installed
- [ ] src/github/secrets.ts exports all 6 functions
- [ ] TypeScript types are properly used
</verification>

<success_criteria>

- @octokit/rest installed as production dependency
- tweetnacl and tweetnacl-util installed for secret encryption
- GitHub secrets service module created with all functions
- Follows existing service module patterns
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-github-deployment-command/02-02-SUMMARY.md`
</output>
