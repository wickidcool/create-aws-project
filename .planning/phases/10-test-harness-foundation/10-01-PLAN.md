---
phase: 10-test-harness-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/__tests__/harness/temp-dir.ts
  - src/__tests__/harness/run-command.ts
  - src/__tests__/harness/temp-dir.spec.ts
  - src/__tests__/harness/run-command.spec.ts
autonomous: true

must_haves:
  truths:
    - "Test can create unique temp directory that does not conflict with other tests"
    - "Temp directories are automatically cleaned up after test completion"
    - "npm commands can be executed with stdout/stderr captured"
    - "execa dependency is installed and typed"
  artifacts:
    - path: "src/__tests__/harness/temp-dir.ts"
      provides: "withTempDir helper for isolated test directories"
      exports: ["withTempDir"]
    - path: "src/__tests__/harness/run-command.ts"
      provides: "runCommand helper for npm execution with output capture"
      exports: ["runCommand", "CommandResult"]
    - path: "package.json"
      provides: "execa dependency"
      contains: '"execa"'
  key_links:
    - from: "src/__tests__/harness/temp-dir.ts"
      to: "fs/promises"
      via: "mkdtemp and rm imports"
      pattern: "import.*mkdtemp.*rm.*from.*fs/promises"
    - from: "src/__tests__/harness/run-command.ts"
      to: "execa"
      via: "execa import"
      pattern: "import.*execa.*from.*execa"
---

<objective>
Create foundational test harness utilities for temporary directory management and npm command execution.

Purpose: Enable future phases to generate and validate projects in isolated environments without polluting the file system.
Output: Two utility modules (temp-dir.ts, run-command.ts) with tests, plus execa dependency installed.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-test-harness-foundation/10-RESEARCH.md
@src/__tests__/generator.spec.ts
@jest.config.ts
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install execa and create temp directory helper</name>
  <files>
    package.json
    package-lock.json
    src/__tests__/harness/temp-dir.ts
    src/__tests__/harness/temp-dir.spec.ts
  </files>
  <action>
1. Install execa as a dev dependency (v9.6.1):
   ```bash
   npm install --save-dev execa
   ```

2. Create `src/__tests__/harness/temp-dir.ts` with:
   - Import `mkdtemp`, `rm` from `fs/promises`
   - Import `tmpdir` from `os`
   - Import `join` from `path`
   - Export `withTempDir<T>(prefix: string, fn: (dir: string) => Promise<T>): Promise<T>`
   - Function creates temp dir via `mkdtemp(join(tmpdir(), prefix))`
   - Uses try-finally to guarantee cleanup via `rm(dir, { recursive: true, force: true })`
   - Cleanup failure logs warning but does not throw (prevents masking test errors)

3. Create `src/__tests__/harness/temp-dir.spec.ts` with tests:
   - Use `@jest/globals` imports (project convention)
   - Test: `withTempDir creates unique directory` - verify directory exists during callback
   - Test: `withTempDir cleans up after success` - verify directory does not exist after return
   - Test: `withTempDir cleans up after error` - throw in callback, verify cleanup still happens
   - Test: `withTempDir returns callback result` - verify return value passes through
   - Test: `concurrent calls create separate directories` - call twice in parallel, verify different paths

Pattern from research:
```typescript
export async function withTempDir<T>(
  prefix: string,
  fn: (dir: string) => Promise<T>
): Promise<T> {
  const dir = await mkdtemp(join(tmpdir(), prefix));
  try {
    return await fn(dir);
  } finally {
    await rm(dir, { recursive: true, force: true }).catch((err) => {
      console.warn(`Failed to clean up temp directory ${dir}:`, err);
    });
  }
}
```
  </action>
  <verify>
    `npm test -- --testPathPattern=temp-dir` passes all tests
    `ls node_modules/execa` confirms execa installed
  </verify>
  <done>
    - execa appears in package.json devDependencies
    - withTempDir function exported from temp-dir.ts
    - All temp-dir.spec.ts tests pass
    - Temp directories created during tests do not persist after test run
  </done>
</task>

<task type="auto">
  <name>Task 2: Create command execution helper</name>
  <files>
    src/__tests__/harness/run-command.ts
    src/__tests__/harness/run-command.spec.ts
  </files>
  <action>
1. Create `src/__tests__/harness/run-command.ts` with:
   - Import `execa` from `execa`
   - Export interface `CommandResult { success: boolean; exitCode: number; output: string; }`
   - Export `runCommand(command: string, args: string[], cwd: string): Promise<CommandResult>`
   - Use `execa(command, args, { cwd, all: true })` for interleaved stdout/stderr capture
   - Wrap in try-catch: success=true on normal return, success=false on throw
   - On catch, extract exitCode and output from error (execa throws with these properties)
   - Handle missing `all` property with fallback to error.message

2. Create `src/__tests__/harness/run-command.spec.ts` with tests:
   - Use `@jest/globals` imports (project convention)
   - Use `withTempDir` from `./temp-dir.js` for test isolation
   - Test: `runCommand succeeds with zero exit code` - run `node --version`, verify success=true, exitCode=0
   - Test: `runCommand captures stdout` - run `node -e "console.log('hello')"`, verify output contains 'hello'
   - Test: `runCommand returns failure for non-zero exit` - run `node -e "process.exit(1)"`, verify success=false, exitCode=1
   - Test: `runCommand captures stderr on failure` - run `node -e "console.error('err'); process.exit(1)"`, verify output contains 'err'
   - Test: `runCommand works in specified cwd` - create file in temp dir, run `ls` or `node -e` to read it

Pattern from research:
```typescript
export interface CommandResult {
  success: boolean;
  exitCode: number;
  output: string;
}

export async function runCommand(
  command: string,
  args: string[],
  cwd: string
): Promise<CommandResult> {
  try {
    const result = await execa(command, args, {
      cwd,
      all: true,
    });
    return {
      success: true,
      exitCode: result.exitCode,
      output: result.all ?? '',
    };
  } catch (error) {
    return {
      success: false,
      exitCode: error.exitCode ?? 1,
      output: error.all ?? error.message,
    };
  }
}
```
  </action>
  <verify>
    `npm test -- --testPathPattern=run-command` passes all tests
  </verify>
  <done>
    - CommandResult interface exported from run-command.ts
    - runCommand function exported from run-command.ts
    - All run-command.spec.ts tests pass
    - Tests demonstrate stdout/stderr capture working
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite and commit</name>
  <files>None (verification only)</files>
  <action>
1. Run full test suite to ensure new code doesn't break existing tests:
   ```bash
   npm test
   ```

2. Verify TypeScript compilation:
   ```bash
   npm run build
   ```

3. Verify lint passes:
   ```bash
   npm run lint
   ```

4. If all passes, stage and commit:
   ```bash
   git add package.json package-lock.json src/__tests__/harness/
   git commit -m "feat(10): add test harness utilities for temp dirs and command execution

   - Add withTempDir() for isolated temp directory with automatic cleanup
   - Add runCommand() for npm command execution with output capture
   - Install execa v9.6.1 for subprocess management
   - Add tests for both utilities

   Implements HARN-02, HARN-05

   Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
   ```
  </action>
  <verify>
    `npm test` shows all tests passing (existing + new)
    `npm run build` exits 0
    `npm run lint` exits 0
    `git log -1` shows commit message
  </verify>
  <done>
    - All existing tests continue to pass
    - Build succeeds
    - Lint passes
    - Changes committed to git
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Temp directory isolation:**
   ```bash
   npm test -- --testPathPattern=temp-dir
   # Should show 5 passing tests
   ```

2. **Command execution:**
   ```bash
   npm test -- --testPathPattern=run-command
   # Should show 5 passing tests
   ```

3. **No file system pollution:**
   ```bash
   ls -la /tmp/harness-* 2>/dev/null || echo "No temp dirs left behind"
   # Should show "No temp dirs left behind"
   ```

4. **Dependency installed:**
   ```bash
   npm ls execa
   # Should show execa@9.x.x
   ```
</verification>

<success_criteria>
Phase 10 is complete when:
- [ ] execa is installed as devDependency
- [ ] withTempDir creates unique temp directories
- [ ] withTempDir cleans up after callback (success or failure)
- [ ] runCommand captures stdout/stderr
- [ ] runCommand returns success=false for non-zero exit codes
- [ ] All tests pass (existing + new)
- [ ] Build and lint succeed
- [ ] Changes committed
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-harness-foundation/10-01-SUMMARY.md`
</output>
