---
phase: 21-fix-aws-github-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/initialize-github.ts
  - src/cli.ts
autonomous: true

must_haves:
  truths:
    - "initialize-github --all configures all environments with credentials, prompting for GitHub PAT only once"
    - "initialize-github dev stage prod works as batch mode with multiple positional args"
    - "initialize-github dev still works exactly as before (backward compatible)"
    - "Batch mode handles individual environment failures gracefully and shows summary"
  artifacts:
    - path: "src/commands/initialize-github.ts"
      provides: "Batch mode for multi-environment GitHub setup"
      contains: "determineBatchEnvironments"
    - path: "src/cli.ts"
      provides: "Updated help text showing --all and batch usage"
      contains: "--all"
  key_links:
    - from: "src/commands/initialize-github.ts"
      to: "src/commands/initialize-github.ts#runInitializeGitHub"
      via: "batch mode detection from args (--all or multiple positional args)"
      pattern: "args\\.includes\\('--all'\\)"
---

<objective>
Add batch mode to the `initialize-github` command so users can configure all environments in a single invocation with one GitHub PAT prompt.

Purpose: Currently users must run `initialize-github` three separate times (once per environment), entering their GitHub PAT each time. This is tedious and error-prone. Batch mode lets users run `initialize-github --all` or `initialize-github dev stage prod` to configure everything at once.

Output: Modified `initialize-github.ts` with batch mode support, updated CLI help text.
</objective>

<execution_context>
@/Users/alwick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alwick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-fix-aws-github-setup/21-RESEARCH.md
@src/commands/initialize-github.ts
@src/cli.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch mode to initialize-github command</name>
  <files>src/commands/initialize-github.ts</files>
  <action>
Modify `runInitializeGitHub` in `src/commands/initialize-github.ts` to support batch mode. The function already receives `args: string[]` from the CLI router.

**1. Add `determineBatchEnvironments` function:**

```typescript
function determineBatchEnvironments(
  args: string[],
  config: { deploymentCredentials?: Record<string, unknown> }
): Environment[] {
  if (args.includes('--all')) {
    const envs = VALID_ENVIRONMENTS.filter(
      env => config.deploymentCredentials?.[env]
    );
    if (envs.length === 0) {
      console.error(pc.red('Error:') + ' No environments have credentials configured.');
      console.error('Run setup-aws-envs first to create deployment credentials:');
      console.error(`  ${pc.cyan('npx create-aws-project setup-aws-envs')}`);
      process.exit(1);
    }
    return [...envs];
  }

  // Multiple positional arguments (filter out flags)
  const envArgs = args.filter(arg => !arg.startsWith('--'));

  for (const envArg of envArgs) {
    if (envArg !== envArg.toLowerCase()) {
      console.error(pc.red('Error:') + ` Environment must be lowercase: ${pc.bold(envArg)}`);
      console.error(`Did you mean: ${pc.cyan(envArg.toLowerCase())}?`);
      process.exit(1);
    }
    if (!isValidEnvironment(envArg)) {
      console.error(pc.red('Error:') + ` Invalid environment: ${pc.bold(envArg)}`);
      console.error('Valid environments: ' + VALID_ENVIRONMENTS.join(', '));
      process.exit(1);
    }
    if (!config.deploymentCredentials?.[envArg]) {
      console.error(pc.red('Error:') + ` No credentials for ${pc.bold(envArg)}.`);
      console.error('Run setup-aws-envs first to create deployment credentials:');
      console.error(`  ${pc.cyan('npx create-aws-project setup-aws-envs')}`);
      process.exit(1);
    }
  }

  return envArgs as Environment[];
}
```

**2. Refactor `runInitializeGitHub` to detect batch mode:**

Batch mode is triggered when:
- `args` contains `--all`, OR
- `args` has more than 1 non-flag argument

When batch mode is detected:
- Call `determineBatchEnvironments()` to get environment list
- Get repo info once (same as current: try git remote, fallback to prompt)
- Prompt for GitHub PAT once
- Create GitHub client once
- Loop over environments with try-catch per environment, collecting results as `Array<{env: string, success: boolean, error?: string}>`
- After loop, print batch summary:
  - Green checkmark for each success: "Configured Development environment"
  - Red X for each failure: "Failed dev: [error message]"
  - Overall summary: "Successfully configured N of M environments"
  - If any failed: "You can retry failed environments individually: npx create-aws-project initialize-github dev"

When NOT batch mode (single env or no args):
- Keep EXACTLY the existing behavior. The current code for single-environment flow must not change at all. This is critical for backward compatibility.

**3. Structure the refactored function roughly as:**

```typescript
export async function runInitializeGitHub(args: string[]): Promise<void> {
  const context = await requireProjectContext();
  const { config } = context;

  // Detect batch mode
  const nonFlagArgs = args.filter(a => !a.startsWith('--'));
  const isBatchMode = args.includes('--all') || nonFlagArgs.length > 1;

  if (isBatchMode) {
    // BATCH MODE
    const environments = determineBatchEnvironments(args, config);
    // ... get repo info once, PAT once, loop with error collection, show summary
  } else {
    // SINGLE MODE (existing behavior, unchanged)
    // ... existing code for single environment
  }
}
```

**Important constraints:**
- PAT stays in memory only, never written to disk
- Individual environment failures must NOT abort the batch — collect results and continue
- Use existing `createGitHubClient`, `setEnvironmentCredentials`, `GITHUB_ENV_NAMES` etc. — no new imports needed
- Keep `handleError` for single mode; in batch mode, catch errors inline and collect them
- The `promptForGitHubPAT`, `getGitRemoteOrigin`, `promptForRepoInfo` functions remain unchanged
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npm test` — all existing tests pass (no regressions).
Manually verify the code structure: batch mode path exists, single mode path is unchanged.
  </verify>
  <done>
`runInitializeGitHub(['--all'])` would configure all environments with credentials in config.
`runInitializeGitHub(['dev', 'stage', 'prod'])` would configure those three environments.
`runInitializeGitHub(['dev'])` still works exactly as before.
Batch mode collects per-environment errors and shows a summary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI help text for batch mode</name>
  <files>src/cli.ts</files>
  <action>
Update the `printHelp()` function in `src/cli.ts` to show the new batch mode options.

Update the `initialize-github` line in the Commands section to mention batch support.

Update the Usage/Examples section to include:
```
  create-aws-project initialize-github --all       Configure all environments
  create-aws-project initialize-github dev stage    Configure specific environments
```

Keep the existing single-environment example too.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Read the updated help text and confirm it accurately describes all three usage patterns (single, multiple, --all).
  </verify>
  <done>
CLI help text shows --all flag and multi-environment usage for initialize-github.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm test` passes with no regressions
3. Code review confirms:
   - Single-env path is unchanged (backward compatible)
   - Batch mode prompts for PAT exactly once
   - Batch mode continues on individual env failure
   - Batch mode shows summary at end
   - CLI help text includes --all and multi-env examples
</verification>

<success_criteria>
- `initialize-github --all` batch mode implemented and compiles
- `initialize-github dev stage prod` multi-arg batch mode implemented
- `initialize-github dev` unchanged (backward compatible)
- Batch errors collected per-environment, not aborting
- CLI help updated with batch examples
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/21-fix-aws-github-setup/21-01-SUMMARY.md`
</output>
