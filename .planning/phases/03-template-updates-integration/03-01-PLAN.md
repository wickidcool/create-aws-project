---
phase: 03-template-updates-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/apps/api/cdk/app.ts
  - templates/.github/actions/deploy-cdk/action.yml
  - templates/root/package.json
autonomous: true
---

<objective>
Update CDK templates and GitHub Actions for multi-account deployment using environment-specific AWS account IDs.

Purpose: Enable generated projects to deploy to separate AWS accounts per environment (dev, stage, prod) when AWS Organizations is enabled.
Output: CDK app that selects account ID based on environment, deploy action that passes environment context, updated npm scripts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-aws-organizations-foundation/01-03-SUMMARY.md
@.planning/phases/02-github-deployment-command/02-03-SUMMARY.md

# Key context from prior phases:
# - Token system has: {{ORG_ENABLED}}, {{DEV_ACCOUNT_ID}}, {{STAGE_ACCOUNT_ID}}, {{PROD_ACCOUNT_ID}}
# - GitHub Environments created: dev, stage, prod with AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY
# - Workflows already have `environment: dev/stage/prod` set correctly

@templates/apps/api/cdk/app.ts
@templates/.github/actions/deploy-cdk/action.yml
@templates/root/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CDK app for multi-account deployment</name>
  <files>templates/apps/api/cdk/app.ts</files>
  <action>
Update CDK app.ts to support multi-account deployment:

1. Add account ID constants after the appName constant:
```typescript
// {{#if ORG_ENABLED}}
// Multi-account configuration from AWS Organizations
const accountIds: Record<string, string> = {
  dev: '{{DEV_ACCOUNT_ID}}',
  stage: '{{STAGE_ACCOUNT_ID}}',
  prod: '{{PROD_ACCOUNT_ID}}',
};
// {{/if ORG_ENABLED}}
```

2. Update the env object to use the appropriate account ID:
```typescript
const env = {
  // {{#if ORG_ENABLED}}
  account: accountIds[environmentName] || process.env.CDK_DEFAULT_ACCOUNT,
  // {{/if ORG_ENABLED}}
  // {{#unless ORG_ENABLED}}
  account: process.env.CDK_DEFAULT_ACCOUNT || process.env.AWS_ACCOUNT_ID,
  // {{/unless ORG_ENABLED}}
  region: process.env.CDK_DEFAULT_REGION || process.env.AWS_REGION || '{{AWS_REGION}}',
};
```

This uses:
- Conditional blocks so existing v1.1 projects (ORG_ENABLED=false) work unchanged
- The accountIds map to select correct account based on environment context
- Fallback to CDK_DEFAULT_ACCOUNT if environment not in map
  </action>
  <verify>Review templates/apps/api/cdk/app.ts has conditional blocks and account lookup logic</verify>
  <done>CDK app selects account ID from tokens when ORG_ENABLED, falls back to env vars otherwise</done>
</task>

<task type="auto">
  <name>Task 2: Update deploy-cdk action to pass environment</name>
  <files>templates/.github/actions/deploy-cdk/action.yml</files>
  <action>
Update the deploy-cdk action to pass environment context to CDK:

1. Change the "Deploy Main Stack" step command from:
```yaml
run: npm run cdk:deploy -- --require-approval never
```
to:
```yaml
run: npm run cdk:deploy -- --require-approval never -c environment=${{ inputs.environment }}
```

This ensures CDK receives the environment context which the app.ts uses to select the correct account ID.
  </action>
  <verify>grep "environment=" templates/.github/actions/deploy-cdk/action.yml shows -c environment parameter</verify>
  <done>deploy-cdk action passes environment context to CDK deploy command</done>
</task>

<task type="auto">
  <name>Task 3: Update package.json CDK scripts</name>
  <files>templates/root/package.json</files>
  <action>
Update the cdk:deploy script and add environment-specific variants:

1. Change "cdk:deploy" to accept context (keep as default for local dev):
```json
"cdk:deploy": "cd apps/api/cdk && cdk deploy --all -c environment=dev",
```

2. Add environment-specific scripts if not present:
```json
"cdk:deploy:stage": "cd apps/api/cdk && cdk deploy --all -c environment=stage",
```

Note: cdk:deploy:prod already exists with -c environment=prod.

The -c environment flag is what triggers CDK to use the correct account ID from the accountIds map.
  </action>
  <verify>grep "cdk:deploy" templates/root/package.json shows environment context in scripts</verify>
  <done>CDK deploy scripts pass environment context, enabling multi-account deployment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] templates/apps/api/cdk/app.ts has {{#if ORG_ENABLED}} conditional blocks
- [ ] templates/apps/api/cdk/app.ts has accountIds map with {{DEV_ACCOUNT_ID}}, {{STAGE_ACCOUNT_ID}}, {{PROD_ACCOUNT_ID}}
- [ ] templates/.github/actions/deploy-cdk/action.yml passes -c environment=${{ inputs.environment }}
- [ ] templates/root/package.json cdk:deploy scripts include -c environment= parameter
- [ ] npm run build succeeds (no TypeScript errors in generator code)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- CDK templates support both single-account (v1.1 compat) and multi-account (v1.2 org) modes
- GitHub Actions will deploy to correct AWS account based on environment
</success_criteria>

<output>
After completion, create `.planning/phases/03-template-updates-integration/03-01-SUMMARY.md`
</output>
