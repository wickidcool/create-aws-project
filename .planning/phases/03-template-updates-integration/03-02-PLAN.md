---
phase: 03-template-updates-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - templates/.github/actions/deploy-web/action.yml
autonomous: false
---

<objective>
Verify deploy-web action and confirm backward compatibility with non-org projects.

Purpose: Ensure the template changes work correctly for both new multi-account projects and existing single-account projects.
Output: Verified deploy-web action, confirmed backward compatibility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-template-updates-integration/03-01-SUMMARY.md

@templates/.github/actions/deploy-web/action.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify deploy-web action environment handling</name>
  <files>templates/.github/actions/deploy-web/action.yml</files>
  <action>
Review the deploy-web action to ensure it correctly:
1. Accepts environment input parameter
2. Uses environment in stack name lookup (e.g., {{PROJECT_NAME_PASCAL}}-Static-${environment})
3. Works with the AWS credentials from GitHub Environments

If the action already correctly uses the environment parameter for S3 bucket and CloudFront distribution lookup, no changes needed.

If the stack name pattern is hardcoded (e.g., -dev suffix), update to use the environment input:
- Change hardcoded `-dev` to `-${{ inputs.environment }}`
- Ensure S3 sync targets correct bucket for environment
- Ensure CloudFront invalidation targets correct distribution

This ensures web deployments go to the correct environment's infrastructure.
  </action>
  <verify>grep "environment" templates/.github/actions/deploy-web/action.yml shows environment parameter is used in stack name lookups</verify>
  <done>deploy-web action uses environment parameter for stack name resolution</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Multi-account CDK deployment support with conditional template blocks</what-built>
  <how-to-verify>
    Test backward compatibility by reviewing template output:

    1. Check CDK app.ts conditionals are balanced:
       - Search for {{#if ORG_ENABLED}} and {{/if ORG_ENABLED}} pairs
       - Search for {{#unless ORG_ENABLED}} and {{/unless ORG_ENABLED}} pairs
       - Ensure each opening tag has a closing tag

    2. Review the account selection logic:
       - When ORG_ENABLED=true: account should come from accountIds[environmentName]
       - When ORG_ENABLED=false: account should come from CDK_DEFAULT_ACCOUNT

    3. Verify deploy-cdk action:
       - Confirm -c environment=${{ inputs.environment }} is present

    4. Verify package.json scripts:
       - cdk:deploy should have -c environment=dev (or similar default)
       - cdk:deploy:stage should exist
       - cdk:deploy:prod should exist

    5. (Optional) Generate a test project:
       - Run: npm run build && npx . test-project --no-install
       - Check generated apps/api/cdk/app.ts has correct structure
       - Check generated .github/actions/deploy-cdk/action.yml passes environment
  </how-to-verify>
  <resume-signal>Type "approved" if templates look correct, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] deploy-web action correctly uses environment parameter
- [ ] Human verified backward compatibility
- [ ] Conditional blocks are balanced in CDK templates
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human confirmed template changes work for both org and non-org projects
- Phase 3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-template-updates-integration/03-02-SUMMARY.md`
</output>
