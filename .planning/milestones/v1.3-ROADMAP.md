# Milestone v1.3: CLI Architecture Refactor

**Status:** âœ… SHIPPED 2026-01-23
**Phases:** 4-9
**Total Plans:** 8

## Overview

Refactored CLI architecture to separate project generation from AWS/GitHub setup. Main wizard became lean (7 prompts for project scaffolding only), with AWS Organizations and GitHub setup extracted into dedicated post-install commands (`setup-aws-envs` and `initialize-github <env>`).

## Phases

### Phase 4: CLI Infrastructure & Command Routing

**Goal**: CLI routes commands correctly and validates project context
**Depends on**: None (foundation)
**Plans**: 2 plans

Plans:
- [x] 04-01: CLI routing, find-up dependency, deprecation notice
- [x] 04-02: Project context detection, command stubs

**Details:**
- Switch-based command routing for simplicity
- find-up for upward config file search
- requireProjectContext() guard for project-scoped commands
- setup-github deprecation notice with migration guidance

---

### Phase 5: Wizard Simplification

**Goal**: Main wizard is lean and generates project config for downstream commands
**Depends on**: Phase 4
**Plans**: 2 plans

Plans:
- [x] 05-01: Remove org prompts from wizard, update test
- [x] 05-02: Remove org setup from CLI, add config file write, update next steps

**Details:**
- Reduced wizard from 15 to 7 prompts
- Removed AWS Organizations imports and setup logic
- Added .aws-starter-config.json generation
- Post-wizard guidance points to setup-aws-envs

---

### Phase 6: setup-aws-envs Command

**Goal**: Users can set up AWS Organizations and environment accounts from generated project
**Depends on**: Phase 5
**Plans**: 1 plan

Plans:
- [x] 06-01: Add ora dependency, implement email collection, command orchestration with progress and error handling

**Details:**
- Sequential email prompts with uniqueness validation
- Ora spinner for AWS operation progress
- Config saved after each account creation (partial success handling)
- Comprehensive AWS error handling (5 exception types)

---

### Phase 7: initialize-github Command

**Goal**: Users can initialize GitHub environments per-environment
**Depends on**: Phase 6
**Plans**: 1 plan

Plans:
- [x] 07-01: STS dependency, cross-account IAM, full command implementation with GitHub integration

**Details:**
- Cross-account IAM client via OrganizationAccountAccessRole
- Interactive environment selection when no arg provided
- Git remote auto-detection with manual fallback
- GitHub PAT prompted interactively (never cached)

---

### Phase 8: Documentation Updates

**Goal**: README.md reflects new CLI architecture with post-install workflow documentation
**Depends on**: Phase 7
**Plans**: 1 plan

Plans:
- [x] 08-01: Update wizard prompts, add Post-Install Setup section, add troubleshooting

**Details:**
- Wizard prompts section updated for 7-prompt flow
- Post-install setup workflow documented
- Troubleshooting section based on actual error handling

---

### Phase 9: Generated Project Documentation

**Goal**: Generated projects include personalized README.md with project structure, commands, and AWS setup workflow
**Depends on**: Phase 8
**Plans**: 1 plan

Plans:
- [x] 09-01: Add platform tokens, create README template with conditionals, register in manifest

**Details:**
- WEB, MOBILE, API platform tokens added to templating system
- README template with 14 conditional blocks
- Platform-specific documentation per user selection

---

## Milestone Summary

**Key Decisions:**
- Switch-based command routing for simplicity and readability
- find-up for ESM-native upward config search
- Config file with configVersion for future compatibility
- Ora spinner for AWS operations progress feedback
- Sequential email prompts to avoid TypeScript self-reference
- Platform tokens for conditional README documentation

**Issues Resolved:**
- TypeScript self-reference in prompts validation (sequential prompts fix)
- Missing accounts field on ProjectConfigMinimal interface
- Unused imports in github-setup.ts (lint fix)
- Test fixtures missing new platform tokens

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

*For current project status, see .planning/PROJECT.md*
*Archived: 2026-01-23 as part of v1.3 milestone completion*
