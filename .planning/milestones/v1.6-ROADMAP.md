# Milestone v1.6: End-to-End AWS Setup

**Status:** SHIPPED 2026-02-13
**Phases:** 17-22
**Total Plans:** 9

## Overview

Make the full AWS setup workflow complete reliably from root credentials through GitHub deployment configuration. Users can now run setup-aws-envs with root credentials and the CLI handles everything: admin user creation, organization setup, account creation, deployment user/key management, CDK bootstrap, and seamless transition to GitHub secret configuration.

## Phases

### Phase 17: Root Credential Handling
**Goal**: CLI detects root credentials and creates admin IAM user automatically
**Depends on**: Phase 16
**Plans**: 2 plans

Plans:
- [x] 17-01: Root credential detection and admin user module with tests
- [x] 17-02: Wire root detection into setup-aws-envs with credential switching

**Details:**
- STS-based root credential detection via GetCallerIdentity (checks for account ID = user ARN pattern)
- Automatic admin IAM user creation with AdministratorAccess policy in `/admin/` path
- Tag-based adoption pattern (`ManagedBy=create-aws-starter-kit`) for idempotent re-runs
- Exponential backoff retry utility for IAM eventual consistency (3-4s window)
- Access key limit handling (2 max per user)
- Admin credentials stored in memory for session, userName+accessKeyId persisted to config
- 16 unit tests covering detection, creation, adoption, and error scenarios

### Phase 18: Architecture Simplification
**Goal**: All AWS/IAM operations consolidated in setup-aws-envs, GitHub operations isolated in initialize-github
**Depends on**: Phase 17
**Plans**: 2 plans

Plans:
- [x] 18-01: Add deployment access key creation to setup-aws-envs and extend config schema
- [x] 18-02: Simplify initialize-github to read credentials from config (no AWS operations)

**Details:**
- Deployment IAM user access key creation moved from initialize-github to setup-aws-envs
- DeploymentCredentials interface added to config schema (`Record<string, DeploymentCredentials>`)
- Idempotent credential handling: checks existing credentials before creating new keys
- Partial failure resilience: calls updateConfig after each successful key creation
- initialize-github stripped of all AWS SDK imports and IAM operations
- Credential validation at start of initialize-github with helpful error directing to setup-aws-envs
- Migration detection for projects with deploymentUsers but no credentials

### Phase 19: Idempotent Setup Improvements
**Goal**: Re-running setup-aws-envs resumes cleanly without redundant prompts
**Depends on**: Phase 18
**Plans**: 1 plan

Plans:
- [x] 19-01: Pre-flight AWS account discovery and conditional email prompting

**Details:**
- Pre-flight account discovery via Organizations ListAccounts API with pagination
- AWS as source of truth: discovers accounts by matching `{projectName}-{env}` pattern
- Conditional email prompting: only collects emails for environments needing account creation
- Config sync after discovery: updates config with discovered accounts immediately
- Existing accounts in config skip email prompt entirely

### Phase 20: End-to-End Verification
**Goal**: Complete workflow from root credentials to deployed project works reliably
**Depends on**: Phase 19
**Plans**: 1 plan

Plans:
- [x] 20-01: Manual test protocol creation and end-to-end workflow verification

**Details:**
- Comprehensive 6-test-case manual protocol covering full v1.6 workflow
- Tests: fresh setup, idempotent re-run, single environment, CDK bootstrap, batch GitHub, continuation prompt
- All tests passed with real AWS credentials by human tester
- Verified idempotency for both setup-aws-envs and initialize-github

### Phase 21: Fix AWS -> GitHub Setup
**Goal**: Improve UX for AWS -> GitHub setup flow by adding batch mode to initialize-github and continuation prompt to setup-aws-envs
**Depends on**: Phase 20
**Plans**: 2 plans

Plans:
- [x] 21-01: Add batch mode to initialize-github (--all flag, multiple positional args, single PAT prompt)
- [x] 21-02: Add continuation prompt to setup-aws-envs (offer inline GitHub setup after AWS completion)

**Details:**
- Batch mode triggers: --all flag or multiple positional args
- Per-environment error collection: batch mode collects results, continues on failure, reports summary
- Single PAT prompt for all environments in batch mode
- Backward compatibility: single-environment mode preserved exactly as-is
- Continuation prompt after setup-aws-envs defaults to yes (natural next step)
- onCancel handling for graceful Ctrl+C with helpful next-step message
- Direct function chaining (import/call, not subprocess spawn)
- AWS -> GitHub flow reduced from 4 commands to 2 confirmation prompts

### Phase 22: Add CDK Bootstrap to Environment Initialization
**Goal**: setup-aws-envs automatically bootstraps CDK in every environment account after deployment user setup
**Depends on**: Phase 21
**Plans**: 1 plan

Plans:
- [x] 22-01: Create CDK bootstrap module and wire into setup-aws-envs

**Details:**
- CDK bootstrap as final step in setup-aws-envs workflow
- Cross-account bootstrap via STS AssumeRole with temporary credentials
- Environment variables (AWS_*) passed to `npx cdk bootstrap` subprocess
- Idempotent design: always run CDK bootstrap (safe to re-run multiple times)
- 12 unit tests covering bootstrap, cross-account, error handling
- 202-line module integrated into setup-aws-envs workflow

---

## Milestone Summary

**Key Decisions:**
- Architecture: ALL AWS/IAM operations in setup-aws-envs, initialize-github is read-config-and-push only
- Root handling: CLI detects root credentials and creates admin IAM user automatically
- Admin user path: `/admin/` path separate from deployment users in `/deployment/`
- Tag-based admin adoption: `ManagedBy=create-aws-starter-kit` tag for idempotent re-runs
- AWS as source of truth: Organizations ListAccounts API authoritative for existing accounts
- STS AssumeRole for CDK bootstrap: temporary credentials for cross-account operations
- Batch mode triggers: --all flag OR multiple positional args
- Continuation prompt defaults to yes: natural workflow progression
- Direct function chaining: import/call for command continuation, not subprocess

**Issues Resolved:**
- Root credentials causing cross-account IAM failures (solved by admin user creation)
- Redundant email prompts on re-run (solved by pre-flight account discovery)
- 4-command workflow friction (reduced to 2 confirmation prompts)
- Missing CDK bootstrap step (automated as part of setup-aws-envs)
- initialize-github making unnecessary AWS API calls (removed all AWS operations)

**Issues Deferred:**
None.

**Technical Debt Incurred:**
None.

---

_For current project status, see .planning/ROADMAP.md_
